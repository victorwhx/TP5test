!function(){function e(e,t){this.imInstance=t,this.id=e.conv_id,this.type=e.conv_type,this.title=e.conv_title,this.subtitle=e.conv_subtitle,this.avatar=e.conv_avatar,this.readMsgId=e.read_msg_id,this.mTime=e.mtime,this.peer=e.peer,this.summary=e.summary,Object.defineProperty(this,"_originalObject",{value:e,enumerable:!1})}function t(e,t){this.imInstance=t,this.convId=e.msg.conv_id,this.convType=e.msg.conv_type,this.fromUcid=e.msg.from_ucid,this.id=e.msg.msg_id,this.localId=e.msg.msg_local_id,this.payload=e.msg.msg_payload,this.type=e.msg.msg_type,this.sendTime=e.msg.send_time,this.seq=e.seq,Object.defineProperty(this,"_originalObject",{value:e,enumerable:!1})}function a(){this._listener={}}function n(e){if(this._events=new a,this.appkey=e.appkey,this.msgApiRoot=e.msgApiRoot,this.mediaApiRoot=e.mediaApiRoot,this.configHeader=e.apiheader,this.ucid=e.ucid,this.port=null,this.extAttr=null,this.convMap={},this.currentSeq=-1,this.msgTimer=0,this.msgTimerLevel=0,this.initMsgWindow={},this.triggerSyncTimer=null,this.state=0,!this.appkey)throw new Error("IM need appkey")}!function(e){"use strict";function t(e,t){var a=(65535&e)+(65535&t),n=(e>>16)+(t>>16)+(a>>16);return n<<16|65535&a}function a(e,t){return e<<t|e>>>32-t}function n(e,n,i,o,s,r){return t(a(t(t(n,e),t(o,r)),s),i)}function i(e,t,a,i,o,s,r){return n(t&a|~t&i,e,t,o,s,r)}function o(e,t,a,i,o,s,r){return n(t&i|a&~i,e,t,o,s,r)}function s(e,t,a,i,o,s,r){return n(t^a^i,e,t,o,s,r)}function r(e,t,a,i,o,s,r){return n(a^(t|~i),e,t,o,s,r)}function c(e,a){e[a>>5]|=128<<a%32,e[(a+64>>>9<<4)+14]=a;var n,c,d,l,u,p=1732584193,h=-271733879,m=-1732584194,g=271733878;for(n=0;n<e.length;n+=16)c=p,d=h,l=m,u=g,p=i(p,h,m,g,e[n],7,-680876936),g=i(g,p,h,m,e[n+1],12,-389564586),m=i(m,g,p,h,e[n+2],17,606105819),h=i(h,m,g,p,e[n+3],22,-1044525330),p=i(p,h,m,g,e[n+4],7,-176418897),g=i(g,p,h,m,e[n+5],12,1200080426),m=i(m,g,p,h,e[n+6],17,-1473231341),h=i(h,m,g,p,e[n+7],22,-45705983),p=i(p,h,m,g,e[n+8],7,1770035416),g=i(g,p,h,m,e[n+9],12,-1958414417),m=i(m,g,p,h,e[n+10],17,-42063),h=i(h,m,g,p,e[n+11],22,-1990404162),p=i(p,h,m,g,e[n+12],7,1804603682),g=i(g,p,h,m,e[n+13],12,-40341101),m=i(m,g,p,h,e[n+14],17,-1502002290),h=i(h,m,g,p,e[n+15],22,1236535329),p=o(p,h,m,g,e[n+1],5,-165796510),g=o(g,p,h,m,e[n+6],9,-1069501632),m=o(m,g,p,h,e[n+11],14,643717713),h=o(h,m,g,p,e[n],20,-373897302),p=o(p,h,m,g,e[n+5],5,-701558691),g=o(g,p,h,m,e[n+10],9,38016083),m=o(m,g,p,h,e[n+15],14,-660478335),h=o(h,m,g,p,e[n+4],20,-405537848),p=o(p,h,m,g,e[n+9],5,568446438),g=o(g,p,h,m,e[n+14],9,-1019803690),m=o(m,g,p,h,e[n+3],14,-187363961),h=o(h,m,g,p,e[n+8],20,1163531501),p=o(p,h,m,g,e[n+13],5,-1444681467),g=o(g,p,h,m,e[n+2],9,-51403784),m=o(m,g,p,h,e[n+7],14,1735328473),h=o(h,m,g,p,e[n+12],20,-1926607734),p=s(p,h,m,g,e[n+5],4,-378558),g=s(g,p,h,m,e[n+8],11,-2022574463),m=s(m,g,p,h,e[n+11],16,1839030562),h=s(h,m,g,p,e[n+14],23,-35309556),p=s(p,h,m,g,e[n+1],4,-1530992060),g=s(g,p,h,m,e[n+4],11,1272893353),m=s(m,g,p,h,e[n+7],16,-155497632),h=s(h,m,g,p,e[n+10],23,-1094730640),p=s(p,h,m,g,e[n+13],4,681279174),g=s(g,p,h,m,e[n],11,-358537222),m=s(m,g,p,h,e[n+3],16,-722521979),h=s(h,m,g,p,e[n+6],23,76029189),p=s(p,h,m,g,e[n+9],4,-640364487),g=s(g,p,h,m,e[n+12],11,-421815835),m=s(m,g,p,h,e[n+15],16,530742520),h=s(h,m,g,p,e[n+2],23,-995338651),p=r(p,h,m,g,e[n],6,-198630844),g=r(g,p,h,m,e[n+7],10,1126891415),m=r(m,g,p,h,e[n+14],15,-1416354905),h=r(h,m,g,p,e[n+5],21,-57434055),p=r(p,h,m,g,e[n+12],6,1700485571),g=r(g,p,h,m,e[n+3],10,-1894986606),m=r(m,g,p,h,e[n+10],15,-1051523),h=r(h,m,g,p,e[n+1],21,-2054922799),p=r(p,h,m,g,e[n+8],6,1873313359),g=r(g,p,h,m,e[n+15],10,-30611744),m=r(m,g,p,h,e[n+6],15,-1560198380),h=r(h,m,g,p,e[n+13],21,1309151649),p=r(p,h,m,g,e[n+4],6,-145523070),g=r(g,p,h,m,e[n+11],10,-1120210379),m=r(m,g,p,h,e[n+2],15,718787259),h=r(h,m,g,p,e[n+9],21,-343485551),p=t(p,c),h=t(h,d),m=t(m,l),g=t(g,u);return[p,h,m,g]}function d(e){var t,a="",n=32*e.length;for(t=0;n>t;t+=8)a+=String.fromCharCode(e[t>>5]>>>t%32&255);return a}function l(e){var t,a=[];for(a[(e.length>>2)-1]=void 0,t=0;t<a.length;t+=1)a[t]=0;var n=8*e.length;for(t=0;n>t;t+=8)a[t>>5]|=(255&e.charCodeAt(t/8))<<t%32;return a}function u(e){return d(c(l(e),8*e.length))}function p(e,t){var a,n,i=l(e),o=[],s=[];for(o[15]=s[15]=void 0,i.length>16&&(i=c(i,8*e.length)),a=0;16>a;a+=1)o[a]=909522486^i[a],s[a]=1549556828^i[a];return n=c(o.concat(l(t)),512+8*t.length),d(c(s.concat(n),640))}function h(e){var t,a,n="0123456789abcdef",i="";for(a=0;a<e.length;a+=1)t=e.charCodeAt(a),i+=n.charAt(t>>>4&15)+n.charAt(15&t);return i}function m(e){return unescape(encodeURIComponent(e))}function g(e){return u(m(e))}function f(e){return h(g(e))}function v(e,t){return p(m(e),m(t))}function w(e,t){return h(v(e,t))}function y(e,t,a){return t?a?v(t,e):w(t,e):a?g(e):f(e)}e.md5=y}(this);var i={timeOffset:0,noop:function(){},makeRequestHeader:function(e,t,a){function n(e){var t=[];return $.each(e,function(e,a){t.push(e+"="+a)}),t.sort(),t.join("&")}var i={},o={},s="";return o=$.extend({"Lianjia-Access-Token":e["Lianjia-Access-Token"]||"1","Lianjia-Device-Id":e.uuid||"","Lianjia-Im-Timestamp":(new Date).getTime()-this.timeOffset},e),i=$.extend(i,o),i=$.extend(i,t),delete i["Lianjia-Uuid"],s=n(i),o["Lianjia-Im-Signature"]=md5(s+a),o}};e.prototype={constructor:e,fetchDetail:function(e){var t=this;e=e||i.noop;var a={conv_id:this.id};$.ajax({url:this.imInstance.msgApiRoot+"/conv/detail/fetch",headers:i.makeRequestHeader(this.imInstance.configHeader,a,this.imInstance.appkey),data:a,dataType:"json",method:"GET",xhrFields:{withCredentials:!0},cache:!0,success:function(a){if(0!==a.errno)throw e(null,t),new Error(a.error);e(a.data,t)},error:function(){throw e(null,t),new Error("/conv/detail/fetch ajax fail.")}})},updateDetail:function(){var e=this;({conv_id:this.id});this.fetchDetail(function(t){e.id=t.conv_id,e.type=t.conv_type,e.title=t.conv_title,e.subtitle=t.conv_subtitle,e.avatar=t.conv_avatar,e.readMsgId=t.read_msg_id,e.mTime=t.mtime,e.peer=t.peer,e.summary=t.summary})}},t.prototype={constructor:t},a.prototype={constructor:a,addListener:function(e,t){"undefined"==typeof this._listener[e]&&(this._listener[e]=[]),"function"==typeof t&&this._listener[e].push(t)},removeListener:function(e,t){var a=this._listener[e];if("function"==typeof t)for(var n=0,i=a.length;n<i;n++)t===a[n]&&a.splice(n,1);else"undefined"==typeof t&&delete this._listener[e]},fireEvent:function(e,t,a){var n=this._listener[e],i=[{type:e,target:a,param:t}];if(n)for(var o=0,s=n.length;o<s;o++)"function"==typeof n[o]&&(t instanceof Array&&(i=i.concat(t)),n[o].apply(this,i))}},n.prototype={constructor:n,initialize:function(){function e(){$.ajax({url:a.msgApiRoot+"/config/sync",headers:i.makeRequestHeader(a.configHeader,{},a.appkey),data:{},dataType:"json",method:"GET",xhrFields:{withCredentials:!0},cache:!0,success:function(e){if(0!==e.errno)throw t(),new Error(e.error);t(e.data.poll.windows)},error:function(){throw t(),new Error("/config/sync ajax fail.")}})}function t(e){a.initMsgWindow=e||[{interval:3,count:10},{interval:6,count:10},{interval:15,count:8},{interval:30,count:4},{interval:60,count:-1}],a.syncConv(0,100,function(e){a.state=1,a.fire("init",[a]),a.triggerSyncMsg(a.currentSeq)})}var a=this;$.ajax({url:this.msgApiRoot+"/time/sync",headers:i.makeRequestHeader(this.configHeader,{},this.appkey),data:{},dataType:"json",method:"GET",xhrFields:{withCredentials:!0},cache:!0,success:function(t){if(0!==t.errno)throw i.timeOffset=0,e(),new Error(t.error);i.timeOffset=Math.round(+new Date-t.data.timestamp),e()},error:function(){throw i.timeOffset=0,e(),new Error("/time/sync ajax fail.")}}),/^(http|https)?:\/\/\w+\.lianjia\.com/.test(location.href)||$.ajax({url:this.mediaApiRoot+"/cookie",headers:i.makeRequestHeader(this.configHeader,{},this.appkey),data:{},dataType:"json",method:"GET",xhrFields:{withCredentials:!0},cache:!0,success:function(e){if(0!==e.errno)throw new Error(e.error);console.log("种cookie成功")},error:function(){throw new Error("/cookie ajax fail.")}})},syncConv:function(t,a,n){function o(t,a,n){var o=arguments.callee,r={offset:t,limit:a};$.ajax({url:s.msgApiRoot+"/user/conv/list",headers:i.makeRequestHeader(s.configHeader,r,s.appkey),data:r,dataType:"json",method:"GET",xhrFields:{withCredentials:!0},cache:!0,success:function(i){if(0!==i.errno)throw n(null,s),new Error(i.error);$.each(i.data.list,function(){s.convMap[this.conv_id]=new e(this,s)}),t+i.data.list.length<i.data.total_count&&i.data.list.length>0?o(t+a,a,n):n(s.convMap,s)},error:function(){throw n(null,s),new Error("/user/conv/list ajax fail.")}})}var s=this;n=n||i.noop,o(t,a,n)},syncMsg:function(a){function n(a){clearTimeout(o.msgTimer);var n={},r=arguments.callee;a===-1?(n.rev_seq=a,n.seq=0):n.seq=a;$.ajax({url:o.msgApiRoot+"/msg/sync",headers:i.makeRequestHeader(o.configHeader,n,o.appkey),data:n,dataType:"json",method:"GET",xhrFields:{withCredentials:!0},timeout:1e4,cache:!0,success:function(n){if(0!==n.errno)throw o.msgTimer=setTimeout(function(){r(o.currentSeq)},1e3*o.initMsgWindow[o.msgTimerLevel].interval),new Error(n.error);if(n.data.list.length>0){o.currentSeq=n.data.list[n.data.list.length-1].seq;var i=[],c=[],d=[];$.each(n.data.list,function(){var a=new t(this,o);switch(o.convMap[a.convId]||0===a.convId||(o.convMap[a.convId]={},o.fetchConversation(a.convId,function(t){o.convMap[a.convId]=new e(t,o)})),a.type){case 100:c.push(a);break;case 101:d.push(a);break;default:i.push(a)}}),i.length>0&&o.fire("message",[i,a]),c.length>0&&o.fire("arrive",[c,a]),d.length>0&&o.fire("read",[d,a]),s=0,o.msgTimerLevel=0}1===n.data.has_more?r(o.currentSeq):(o.initMsgWindow[o.msgTimerLevel].count===-1?s=0:s>=o.initMsgWindow[o.msgTimerLevel].count&&(s=0,o.msgTimerLevel=Math.min(o.msgTimerLevel+1,o.initMsgWindow.length-1)),s++,o.msgTimer=setTimeout(function(){r(o.currentSeq)},1e3*o.initMsgWindow[o.msgTimerLevel].interval)),a===-1&&o.fire("start",[o])},error:function(){throw o.msgTimer=setTimeout(function(){r(o.currentSeq)},1e3*o.initMsgWindow[o.msgTimerLevel].interval),new Error("/msg/sync ajax fail.")}})}var o=this;this.msgTimerLevel=0;var s=0;n(a)},triggerSyncMsg:function(e){var t=this;this.triggerSyncTimer&&clearTimeout(this.triggerSyncTimer),this.triggerSyncTimer=setTimeout(function(){t.syncMsg(e)},100)},create:function(t,a,n){var o=this,s="",r={};if(n=n||i.noop,1===a){if(t instanceof Array){if(t.length>1)throw new Error("Error #42002: conv_type === 1 only allow 2 members. Please see http://wiki.lianjia.com/pages/viewpage.action?pageId=9899018 .");s=t.join(",")}else s=t;if(s===this.ucid)throw new Error("Error #42003: conv_type === 1 can't talk to self. Please see http://wiki.lianjia.com/pages/viewpage.action?pageId=9899018 .");r={members:t,conv_type:a},$.ajax({url:o.msgApiRoot+"/conv/create",headers:i.makeRequestHeader(this.configHeader,r,this.appkey),data:r,dataType:"json",method:"POST",xhrFields:{withCredentials:!0},cache:!0,success:function(t){if(0!==t.errno)throw n(null,o),new Error(t.error);var a=new e(t.data,o);o.convMap[a.id]=a,n(a,o)},error:function(){throw n(null,o),new Error("/conv/create ajax fail.")}})}else s=t.join(","),r={members:s,conv_type:a},$.ajax({url:o.msgApiRoot+"/conv/create",headers:i.makeRequestHeader(this.configHeader,r,this.appkey),data:r,dataType:"json",method:"POST",xhrFields:{withCredentials:!0},cache:!0,success:function(t){if(0!==t.errno)throw n(null,o),new Error(t.error);n(new e(t.data,o))},error:function(){throw n(null,o),new Error("/conv/create ajax fail.")}})},talkTo:function(e,t,a){var n=this;a=a||i.noop,this.getTalk(e,function(i){i?n.sendTo(i.id,t,a):n.create(e,1,function(e){n.sendTo(e.id,t,a)})})},sendTo:function(e,a,n){var o=this,s={conv_id:e,msg_local_id:a.localId||+new Date,msg_type:a.type,msg_payload:a.payload},r="";(o.port||o.extAttr)&&(console.log(o.extAttr),r=JSON.stringify({biz_src:Object.assign({},{port:o.port},o.extAttr)})),r&&(s.msg_attr=r),n=n||i.noop,$.ajax({url:this.msgApiRoot+"/msg/send",headers:i.makeRequestHeader(this.configHeader,s,this.appkey),data:s,dataType:"json",method:"POST",xhrFields:{withCredentials:!0},cache:!0,success:function(e){if(0!==e.errno)throw n(null,o),new Error(e.error);var i=new t({msg:{conv_id:e.data.conv_id,from_ucid:o.ucid,msg_id:e.data.msg_id,msg_local_id:e.data.msg_local_id,msg_payload:a.payload,msg_type:a.type,send_time:e.data.send_time},seq:-1},o);n(i,o),o.triggerSyncMsg(o.currentSeq)},error:function(){throw n(null,o),new Error("/msg/send ajax fail.")}})},uploadPicture:function(e,t,a){var n=this,o=new FormData;o.append("conv_id",e),o.append("image",t),$.ajax({url:this.mediaApiRoot+"/image/upload",headers:i.makeRequestHeader(this.configHeader,{},this.appkey),data:o,dataType:"json",processData:!1,contentType:!1,method:"POST",xhrFields:{withCredentials:!0},cache:!0,success:function(e){if(0!==e.errno)throw a(null,n),new Error(e.error);a(JSON.stringify(e.data),n)},error:function(){throw a(null,n),new Error("/image/upload ajax fail.")}})},markRead:function(e,t){var a=this,n={conv_id:e.convId,msg_id:e.id};t=t||i.noop,$.ajax({url:this.msgApiRoot+"/msg/read",headers:i.makeRequestHeader(this.configHeader,n,this.appkey),data:n,dataType:"json",method:"POST",xhrFields:{withCredentials:!0},cache:!0,success:function(e){if(0!==e.errno)throw t(null,a),new Error(e.error);t(e.data,a)},error:function(){throw t(null,a),new Error("/msg/read ajax fail.")}})},fetchConversation:function(e,t){var a=this,n={conv_id:e};t=t||i.noop,$.ajax({url:this.msgApiRoot+"/conv/detail/fetch",headers:i.makeRequestHeader(this.configHeader,n,this.appkey),data:n,dataType:"json",method:"GET",async:!1,xhrFields:{withCredentials:!0},cache:!0,success:function(e){if(0!==e.errno)throw t(null,a),new Error(e.error);t(e.data,a)},error:function(){throw t(null,a),new Error("/conv/detail/fetch ajax fail.")}})},getTalk:function(e,t){var a=this;t=t||i.noop;var n=null;$.each(this.convMap,function(){var t=this;if(1===t.conv_type&&t.peer.ucid===e)return n=this,!1}),t(n,a)},getHistory:function(e,a){var n=this;a=a||i.noop,$.ajax({url:this.msgApiRoot+"/msg/list",headers:i.makeRequestHeader(this.configHeader,e,this.appkey),data:e,dataType:"json",method:"GET",xhrFields:{withCredentials:!0},cache:!0,success:function(e){if(0!==e.errno)throw a(null,n),new Error(e.error);var i=e.data.list,o=[];$.each(i,function(){o.push(new t({msg:this},n))}),a(o,n)},error:function(){throw a(null,n),new Error("/msg/list ajax fail.")}})},getUsersInfo:function(e,t){var a=this;t=t||i.noop,$.ajax({url:this.msgApiRoot+"/user/detail/fetch",headers:i.makeRequestHeader(this.configHeader,e,this.appkey),data:e,dataType:"json",method:"GET",xhrFields:{withCredentials:!0},cache:!0,success:function(e){if(0!==e.errno)throw t(null,a),new Error(e.error);t(e.data.list,a)},error:function(){throw t(null,a),new Error("/user/detail/fetch")}})},encodeHtml:function(e){return e.replace(/</g,"&lt;").replace(/>/g,"&gt;")},on:function(e,t){this._events.addListener(e,t)},off:function(e,t){this._events.removeListener(e,t)},fire:function(e,t){this._events.fireEvent(e,t,this)},destory:function(){this.fire("destory",[this]),clearTimeout(this.msgTimer),delete this._events._listener}},window.ImCore=n}(),function(e,t,a){var n=a(t);"function"==typeof define&&define.amd?define(function(){return n}):"object"==typeof exports?n.exports=n:t[e]=n,window[e]=n}("LianjiaIM",this,function(){function _EventEmitter(){"use strict";function e(){}"function"!=typeof Object.create&&(Object.create=function(){var e=function(){};return function(t){if(arguments.length>1)throw Error("Second argument not supported");if("object"!=typeof t)throw TypeError("Argument must be an object");e.prototype=t;var a=new e;return e.prototype=null,a}}()),Object.keys||(Object.keys=function(){var e=Object.prototype.hasOwnProperty,t=!{toString:null}.propertyIsEnumerable("toString"),a=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],n=a.length;return function(i){if("object"!=typeof i&&("function"!=typeof i||null===i))throw new TypeError("Object.keys called on non-object");var o,s,r=[];for(o in i)e.call(i,o)&&r.push(o);if(t)for(s=0;s<n;s++)e.call(i,a[s])&&r.push(a[s]);return r}}()),e.extend=function(t){function a(){this&&n(this,arguments),this&&this._initialize_&&this._initialize_.apply(this,arguments)}var n=this,i=n.prototype,o=a.prototype=Object.create(i);for(var s in t){if("constructor"===s)return;var r=t[s];if("function"==typeof r&&i[s]&&"function"==typeof i[s])r=function(e,t){return function(){var a=this._super;this._super=i[e];var n=t.apply(this,arguments);return this._super=a,n}}(s,r);else if("object"==typeof r&&i[s]&&"object"==typeof i[s])for(var c in i[s])r[c]||(r[c]=i[s][c]);o[s]=r}return a.extend=e.extend,a};var t=e.extend({_initialize_:function(e){var t=this;t._eventList={},t._eventTriggerd_={},this.initialize&&this.initialize.apply(this,arguments),this._promise_="boolean"==typeof e&&e},on:function(e,t){if(!e||!t)throw"type of fn is required";var a=this,n=a._eventList[e];n||(n=[],a._eventList[e]=n),n.push(t)},off:function(e,t){var a=this;if(!e)return void(a._eventList={});var n=a._eventList[e];if(n&&n.length){if(!t){for(;n.pop(););return}for(var i=0,o=n.length;i<o;i++)if(n[i]==t||n[i]==t.fn)return void n.splice(i,1)}},trigger:function(e){if(e){var t=this,a=Array.prototype.slice.call(arguments,1);t._promise_&&(t._eventTriggerd_[e]=a);var n=t._eventList[e];if(n&&n.length)for(var i=0;i<n.length;i++)if(n[i].apply(t,a)===!1)return!1}},before:function(e,t){var a,n=this;return function(){return--e>0?a=t.apply(n,arguments):t=null,a}},once:function(e,t){var a=this;e&&t&&a.on(e,a.before(2,t))},destroy:function(){var e=this;e._eventList=null},always:function(e,t){var a=this;a.on(e,t),a._eventTriggerd_[e]&&t.apply(null,a._eventTriggerd_[e])}});return t}function _Trans(){function e(t){if(!(this instanceof e))return new e(t);var a={url:"",method:"get",dataType:"json",validateCode:!0,args:{},type:"ajax"};this.opt=$.extend(a,t),"jsonp"==this.opt.type&&(this.opt.dataType="jsonp")}return $.extend(e.prototype,{request:function(e,t){var a={success:$.noop,fail:$.noop,timeout:$.noop,timeout:15e3};$.extend(a,t);var n=$.Deferred(),i=this;$.extend(i.opt.args,e);$.ajax({url:i.opt.url,type:i.opt.method,dataType:i.opt.dataType,data:i.opt.args,timeout:i.opt.timeout}).success(function(e){if(i.opt.validateCode===!0&&e&&"code"in e){if(1!=e.code)return void n.reject(e);if(e.code==-1)return void($.listener&&$.listener.trigger("unlogin"));e.data&&!$.isArray(e.data)&&(e=e.data)}n.resolve(e)}).fail(function(e){n.reject(e)});return n},setArgs:function(e){$.extend(this.opt.args,e)}}),e}function _getCommonEnv(){function e(){var e=$.parseURL(location.href);a.host=e.host,a.scheme=e.scheme,a.port=e.port;var t=a.host.match(/.*\.(lianjia|ke)\.com/)[1];0===t.indexOf("dev")?a.env="dev":0===t.indexOf("test")&&(a.env="test")}function t(e){var t="";return e.scheme&&(t+=e.scheme+"://"),e.host&&(t+=e.host),e.port&&(t+=":"+e.port),e.path&&(t+="/"+e.path),e.query&&(t+="?"+e.query),e.hash&&(t+="#"+e.hash),t}var a={host:"",scheme:"",port:"",env:"online"},n={};return n.getEnv=function(){return a.env},n.fixedHost=function(e){if(!e)return a.host;var t=e.substring(0,e.indexOf("."));switch(a.env){case"dev":case"test":if(0!==t.indexOf(a.env))return a.env+e;break;case"online":}return e},n.fixedUrl=function(e,i){i=i||!1,e.indexOf("http")<0&&(e=location.protocol+e);var o=$.parseURL(e);return o.host?(!i&&(o.host=n.fixedHost(o.host)),o.port=a.port,o.scheme||(o.scheme=a.scheme)):(o.host=a.host,o.scheme=a.scheme,o.port=a.port),t(o)},n.isSameDomain=function(e){var t=$.parseURL(e);return t.host==a.host},e(),$.env=n,n}function _pushMessage(e){return function(e){var t=$.env.fixedUrl("//ajax.lianjia.com/ajax/user/favorite/getnotifynum/"),a={house_showing:{url:"//user.lianjia.com/site/seeSchedule",text:'你的看房日程有<span class="unreadNumber">#{unread}</span>条更新'},community_new_house_source:{url:"//user.lianjia.com/?filter=3",text:'你关注的小区有<span class="unreadNumber">#{unread}</span>条新上'},deal:{url:"//user.lianjia.com/?filter=1",text:'你关注的房源有<span class="unreadNumber">#{unread}</span>条成交'},price_changed:{url:"//user.lianjia.com/?filter=2",text:'你关注的房源有<span class="unreadNumber">#{unread}</span>条变价'},"search:new":{url:"//user.lianjia.com/?filter=4",text:'你保存的搜索条件有<span class="unreadNumber">#{unread}</span>条变动'},on_answer_insert_concern:{url:"//user.lianjia.com/site/myWenda/?filter=1",text:'您关注的问题有<span class="unreadNumber">#{unread}</span>条回复'},on_answer_insert:{url:"//user.lianjia.com/site/myWenda/",text:'您提问的问题有<span class="unreadNumber">#{unread}</span>条回复'},on_extra_answer_pass:{url:"//user.lianjia.com/site/myWenda/?filter=2",text:'您收到<span class="unreadNumber">#{unread}</span>条新追答'},on_special_question_pass:{url:"//user.lianjia.com/site/myWenda/?filter=3",text:'您收到<span class="unreadNumber">#{unread}</span>条定向提问'},on_extra_question_pass:{url:"//user.lianjia.com/site/myWenda/?filter=4",text:'您收到<span class="unreadNumber">#{unread}</span>条追问'},xuequ_bbs:{url:"//user.lianjia.com/site/bbs?type=4",text:'论坛有<span class="unreadNumber">#{unread}</span>条回复'},ting_shou:{url:"//user.lianjia.com/",text:'您关注的<span class="unreadNumber">#{unread}</span>套房源已下架'}},n=$.extend({},a,{on_extra_answer_pass:{url:"//agent.lianjia.com/preference/wenda/?filter=2",text:'您收到<span class="unreadNumber">#{unread}</span>条新追答'},on_special_question_pass:{url:"//agent.lianjia.com/preference/wenda/?filter=3",text:'您收到<span class="unreadNumber">#{unread}</span>条定向提问'},on_extra_question_pass:{url:"//agent.lianjia.com/preference/wenda/?filter=4",text:'您收到<span class="unreadNumber">#{unread}</span>条追问'}});$.ajax({url:t,type:"get",dataType:"jsonp",success:function(t){if(0===t.errno){var i=t.data.is_agent?n:a,o=0;for(var s in t.data.group_by_type)0!==t.data.group_by_type[s].unread&&i.hasOwnProperty(s)&&(o+=t.data.group_by_type[s].unread);0!==o&&(e.tipContainer.html(e.tipTpl.render({unreadNum:o})),e.container.html(e.msgTpl.render({group_by_type:t.data.group_by_type,pushMsgMap:i})))}}})}}function _crossRequest(){function e(e,t){var a=document.createElement("iframe");return a.id=e,a.name=e,a.src=t,a.style.cssText="display:none;width:0px;height:0px;",a.width=0,a.height=0,a.title="empty",document.body.appendChild(a),a}var t=new LJMessenger("LIANJIA_CROSS_MESSAGE","LIANJIA-CROSS");t.listen(function(e){e=JSON.parse(e);var a=e.name;t.targets[a]&&("state"==e.type?(t.targets[a].readyState="ready",t.targets[a].dealReady()):t.targets[a].deal(e.data,e.success))});var a={},n=function(e,t){var a=this;a.domain=e,t=t||$.parseURL(e).host.replace(/\./g,"-"),a.name=t,a.init()};return $.extend(n.prototype,{init:function(){var a=this,n=a.domain+"/xd/api/?name="+a.name,i=e(a.name,n);a.iframe=i.contentWindow,t.addTarget(a.iframe,a.name),a.reqArray=[],t.targets[a.name].deal=function(e,n){t.targets[a.name].isRequest=!1;var i=a.reqArray.shift(),o=!1;try{o=e}catch(e){}n?i.defer.resolve(o):i.defer.reject(o),a.next()},t.targets[a.name].dealReady=function(){a.next()}},next:function(){var e=this;if(t.targets[e.name].readyState&&e.reqArray.length&&!t.targets[e.name].isRequest){t.targets[e.name].isRequest=!0;var a=e.reqArray[0],n={type:"request",data:a.request},i=JSON.stringify(n);t.targets[e.name].send(i)}},request:function(e){var t=this,a=$.Deferred();return t.reqArray.push({defer:a,request:e}),t.next(),a}}),function(e,t){return a[e]?a[e]:a[e]=new n(e,t)}}function _trans(){var e=$.EventEmitter,t=_crossRequest(),a=_getCommonEnv(),n=!1,i=e.extend({initialize:function(e){var i={url:"",type:"get",dataType:"json",args:{}};$.extend(i,e),i.url=a.fixedUrl(i.url),i.method=i.type;var o=this;if(o.opt=i,!n){var s=a.fixedUrl($.parseURL(i.url).host);a.isSameDomain(s)?o.isSame=!0:o.crossRequest=t(s)}},request:function(e){var t=this,a=t.opt;return $.extend(a.args,e),a.data=a.args,n||t.isSame?$.ajax(a):this.crossRequest.request(a)}});return i}function _sticker(){return[{face:"0",chara:"[微笑]",code:"/::)"},{face:"1",chara:"[伤心]",code:"/::~"},{face:"2",chara:"[美女]",code:"/::B"},{face:"3",chara:"[发呆]",code:"/::|"},{face:"4",chara:"[墨镜]",code:"/:8-)"},{face:"5",chara:"[哭]",code:"/::<"},{face:"6",chara:"[羞]",code:"/::$"},{face:"7",chara:"[哑]",code:"/::X"},{face:"8",chara:"[睡]",code:"/::Z"},{face:"9",chara:"[小哭]",code:"/::'("},{face:"10",chara:"[囧]",code:"/::-|"},{face:"11",chara:"[怒]",code:"/::@"},{face:"12",chara:"[调皮]",code:"/::P"},{face:"13",chara:"[笑]",code:"/::D"},{face:"14",chara:"[惊讶]",code:"/::O"},{face:"15",chara:"[难过]",code:"/::("},{face:"16",chara:"[酷]",code:"/::+"},{face:"17",chara:"[汗]",code:"/:--b"},{face:"18",chara:"[抓狂]",code:"/::Q"},{face:"19",chara:"[吐]",code:"/::T"},{face:"20",chara:"[大笑]",code:"/:,@P"},{face:"21",chara:"[快乐]",code:"/:,@-D"},{face:"22",chara:"[奇]",code:"/::d"},{face:"23",chara:"[傲]",code:"/:,@o"},{face:"24",chara:"[饿]",code:"/::g"},{face:"25",chara:"[累]",code:"/:|-)"},{face:"26",chara:"[吓]",code:"/::!"},{face:"27",chara:"[小汗]",code:"/::L"},{face:"28",chara:"[高兴]",code:"/::>"},{face:"29",chara:"[闲]",code:"/::,@"},{face:"30",chara:"[努力]",code:"/:,@f"},{face:"31",chara:"[骂]",code:"/::-S"},{face:"32",chara:"[疑问]",code:"/:?"},{face:"33",chara:"[秘密]",code:"/:,@x"},{face:"34",chara:"[乱]",code:"/:,@@"},{face:"35",chara:"[疯]",code:"/::8"},{face:"36",chara:"[哀]",code:"/:,@!"},{face:"37",chara:"[鬼]",code:"/:!!!"},{face:"38",chara:"[打击]",code:"/:xx"},{face:"39",chara:"[再见]",code:"/:bye"},{face:"40",chara:"[中汗]",code:"/:wipe"},{face:"41",chara:"[抠]",code:"/:dig"},{face:"42",chara:"[鼓掌]",code:"/:handclap"},{face:"43",chara:"[糟糕]",code:"/:&-("},{face:"44",chara:"[恶搞]",code:"/:B-)"},{face:"45",chara:"[左什么]",code:"/:<@"},{face:"46",chara:"[右什么]",code:"/:@>"},{face:"47",chara:"[小累]",code:"/::-O"},{face:"48",chara:"[看]",code:"/:>-|"},{face:"49",chara:"[委屈]",code:"/:P-("},{face:"50",chara:"[大难过]",code:"/::'|"},{face:"51",chara:"[坏]",code:"/:X-)"},{face:"52",chara:"[亲]",code:"/::*"},{face:"53",chara:"[惊吓]",code:"/:@x"},{face:"54",chara:"[可怜]",code:"/:8*"},{face:"55",chara:"[刀]",code:"/:pd"},{face:"56",chara:"[水果]",code:"/:<W>"},{face:"57",chara:"[酒]",code:"/:beer"},{face:"58",chara:"[篮球]",code:"/:basketb"},{face:"59",chara:"[乒乓]",code:"/:oo"},{face:"60",chara:"[咖啡]",code:"/:coffee"},{face:"61",chara:"[美食]",code:"/:eat"},{face:"62",chara:"[动物]",code:"/:pig"},{face:"63",chara:"[鲜花]",code:"/:rose"},{face:"64",chara:"[枯]",code:"/:fade"},{face:"65",chara:"[唇]",code:"/:showlove"},{face:"66",chara:"[爱]",code:"/:heart"},{face:"67",chara:"[分手]",code:"/:break"},{face:"68",chara:"[生日]",code:"/:cake"},{face:"69",chara:"[电]",code:"/:li"}]}function LianjiaIM(e,t){var a=this;if(!e.appid||!e.appkey)throw new Error("IM Error: need appkey & appid to init lianjia IM.");this.login=e.login,this.token=e.token,this.is_ljbb=e.is_ljbb,this.downAppUrl=e.downAppUrl||"//www.lianjia.com/client/",this.appDesc=e.appDesc||"立即下载链家APP，随时随地聊~",this.header={"Lianjia-Im-Protocal-Version":"1.1","Lianjia-App-Id":e.appid,"Lianjia-Access-Token":e.token||"1","Lianjia-Device-Id":_util.getCookie("lianjia_uuid")},this.userData=$.extend({uuid:_util.getCookie("lianjia_uuid"),cityid:_util.getCookie("select_city")},e.userData||{}),this.userData.code||(a.userData=$.extend({ucid:_util.getCookie("lianjia_uuid"),name:"游客",avatar:"",type:1},a.userData)),a.BangInfo=JSON.parse(localStorage.getItem("BangInfo")||"{}"),a.BangInfoNow=a.BangInfo[a.userData.ucid]||{},a.bangData=$.extend({},{conv_id:"",callUuid:"",skillCode:""},a.BangInfoNow),$(window).on("storage",function(e){"BangInfo"==e.originalEvent.key&&(a.BangInfo=JSON.parse(localStorage.getItem("BangInfo")||"{}"),a.BangInfoNow=a.BangInfo[a.userData.ucid]||{},a.bangData=$.extend({},{conv_id:"",callUuid:"",skillCode:""},a.BangInfoNow))}),this.updateBangInfo=function(){this.BangInfo[this.userData.ucid]=$.extend({},this.BangInfoNow),localStorage.setItem("BangInfo",JSON.stringify(this.BangInfo))},this.bangMsgList={},this.visibleBang=!1,this.isFirstInline=!0,this.pageConf=e,this.firstInitMessageList=!0,this.staticRoot=e.staticRoot.replace(/\/\?_v=\d*/g,""),this.is_ljbb!==!1&&this.is_ljbb?this.rootnode=$(['<div class="lianjiaim im-fold" data-role="lianjiaim">','<div class="lianjiaim-shandow clear">','<div class="lianjiaim-wrap" data-role="im-wrap">','<div class="lianjiaim-head" data-role="im-head">','<span data-role="im-title">在线咨询</span>','<span class="lianjiaim-head-num" data-role="im-unread" data-unread="0" style="display: none;">0</span>','<a class="lianjiaim-head-closebtn" title="收起" data-role="im-foldbtn">收起</a>',"</div>",'<div class="lianjiaim-body" data-role="im-body">','<ul class="lianjiaim-service" data-role="im-serviceitem-container">','<li class="lianjiaim-body-item">','<div class="im-item-show clear">',"<table>","<tbody>","<tr>",'<td class="im-item-avatar">','<img src="'+this.staticRoot+'/pc/asset/lianjiaIM/img/imgV2/icon_serv@2xV2.png" alt="" width="40" height="40" data-role="im-listitem-item-avatar">','<i data-role="im-listitem-item-newmsg" style="display: none;" data-newmsg="0">0</i>',"</td>",'<td class="im-item-cont">','<span class="name" data-role="im-listitem-item-name">链家帮帮</span>','<span class="text" data-role="im-listitem-item-text">链家网官方人工客服</span>',"</td>","</tr>","</tbody>","</table>","</div>","</li>","</ul>",'<ul data-role="im-listitem-container" style="display: none;"></ul>','<div class="lianjiaim-noagent" data-role="im-noagent-container" style="">','<div class="noagent-title">没有聊过的经纪人</div>',"</div>","</div>","</div>",'<div class="lianjiaim-window im-online" data-role="im-window" data-agentid="" style="display: none;">','<div class="lianjiaim-wintitle">',"<i>在线</i>",'<span class="im-wt-name" data-role="im-window-name"></span>','<a class="im-wt-closebtn" title="关闭" data-role="im-window-closebtn">关闭</a>',"</div>",'<div class="lianjiaim-wincont">','<div class="im-wc-hint"><span data-role="im-window-offlinename"></span>当前不在线，您可以在线留言</div>','<div class="im-wc-chat" data-role="im-window-chatcontainer">','<p class="chat-tophint">聊天的时候，经纪人无法知道您的手机号！</p>','<div data-role="im-logtrigger"></div>','<ul data-role="im-window-msgcontainer"></ul>',"</div>",'<div class="im-wc-input">','<div class="im-input-container" data-role="im-input-container">','<textarea placeholder="点击输入您想要咨询的问题…" data-role="im-input-textarea"></textarea>','<a class="im-input-insertpic" title="插入图片" data-role="im-input-picbtn">插入图片</a>','<input type="file" style="display: none;" accept=".gif,.jpg,.jpeg,.png,.bmp" data-role="im-input-picupload"/>','<span class="im-errorlog" data-role="im-errorlog" style="display: none;"></span>',"</div>",'<div class="im-btn-container">','<a href="//www.lianjia.com/client/" target="_blank" title="下载链家APP">立即下载链家APP，随时随地聊~</a>','<input type="button" value="发送" class="send" data-role="im-input-sendbtn"/>',"</div>","</div>","</div>","</div>",'<div class="lianjiaim-window im-online disabled" data-role="im-bang" style="display: none;">','<div class="lianjiaim-wintitle">',"<i>在线</i>",'<span class="im-wt-name">链家帮帮</span>','<span class="im-wt-time">在线人工服务时间：9:00 - 23:00</span>','<a class="im-wt-closebtn" title="关闭" data-role="bang-close">关闭</a>',"</div>",'<div class="lianjiaim-wincont">','<div class="im-wc-chat bang-chatcontainer" data-role="bang-chatcontainer">','<ul data-role="bang-msgcontainer"></ul>',"</div>",'<div class="im-wc-input">','<div class="im-input-container" data-role="im-input-container">','<textarea placeholder="点击输入您想要咨询的问题…" data-role="bang-textarea"></textarea>','<a class="im-input-insertpic" title="插入图片" data-role="bang-picbtn">插入图片</a>','<input type="file" style="display: none;" accept=".gif,.jpg,.jpeg,.png,.bmp" data-role="bang-picupload"/>',"</div>",'<div class="im-btn-container">','<input type="button" value="发送" class="send" data-role="bang-send"/>','<input type="button" value="结束对话" class="end" data-role="bang-end" style="display: none;"/>',"</div>","</div>","</div>","</div>","</div>",'<div class="lianjiaim-personcard" data-role="im-pcard" style="display: none; top: 9999em; left: 9999em;">','<div class="im-personcard-top clear">','<div class="im-personcard-avatar">','<img src="" alt="" width="78" height="78" data-role="im-pcard-avatar"/>',"</div>",'<div class="im-personcard-detail">','<div class="im-personname-wrap">','<span class="im-personname" data-role="im-pcard-name"></span>','<span class="im-gray" data-role="im-pcard-grade"></span>',"</div>","<div>",'<span class="im-gray">主营商圈：</span>','<span data-role="im-pcard-district"></span>',"</div>","<div>",'<span class="im-gray">所属门店：</span>','<span data-role="im-pcard-store"></span>',"</div>","<div>",'<span class="im-gray">从业年限：</span>','<span data-role="im-pcard-workage"></span>',"</div>","</div>","</div>",'<div class="im-personcard-bottom">',"<table>","<tbody>","<tr>","<td>","<span>累计成交：</span>",'<span class="im-red" data-role="im-pcard-totaldeal"></span>',"</td>","<td>","<span>月总带看：</span>",'<span class="im-red" data-role="im-pcard-monthshow"></span>',"</td>","<td>","<span>好评率：</span>",'<span class="im-red" data-role="im-pcard-praiserate"></span>',"</td>","</tr>","</tbody>","</table>","</div>",'<a class="im-personcard-shopbtn" href="" target="_blank" title="进入店铺" data-role="im-pcard-shoplink">进入店铺</a>',"</div>","</div>"].join("")):this.rootnode=$(['<div class="lianjiaim im-fold" data-role="lianjiaim">','<div class="lianjiaim-shandow clear">','<div class="lianjiaim-wrap" data-role="im-wrap">','<div class="lianjiaim-head" data-role="im-head">','<span data-role="im-title">在线咨询</span>','<span class="lianjiaim-head-num" data-role="im-unread" data-unread="0" style="display: none;">0</span>','<a class="lianjiaim-head-closebtn" title="收起" data-role="im-foldbtn">收起</a>',"</div>",'<div class="lianjiaim-body" data-role="im-body">','<ul data-role="im-listitem-container" style="display: none;"></ul>','<div class="lianjiaim-noagent" data-role="im-noagent-container" style="">','<div class="noagent-title">没有聊过的经纪人</div>',"</div>","</div>","</div>",'<div class="lianjiaim-window im-online" data-role="im-window" data-agentid="" style="display: none;">','<div class="lianjiaim-wintitle">',"<i>在线</i>",'<span class="im-wt-name" data-role="im-window-name"></span>','<a class="im-wt-closebtn" title="关闭" data-role="im-window-closebtn">关闭</a>',"</div>",'<div class="lianjiaim-wincont">','<div class="im-wc-hint"><span data-role="im-window-offlinename"></span>当前不在线，您可以在线留言</div>','<div class="im-wc-chat" data-role="im-window-chatcontainer">','<p class="chat-tophint">聊天的时候，经纪人无法知道您的手机号！</p>','<div data-role="im-logtrigger"></div>','<ul data-role="im-window-msgcontainer"></ul>',"</div>",'<div class="im-wc-input">','<div class="im-input-container" data-role="im-input-container">','<textarea placeholder="点击输入您想要咨询的问题…" data-role="im-input-textarea"></textarea>','<a class="im-input-insertpic" title="插入图片" data-role="im-input-picbtn">插入图片</a>','<input type="file" style="display: none;" accept=".gif,.jpg,.jpeg,.png,.bmp" data-role="im-input-picupload"/>','<span class="im-errorlog" data-role="im-errorlog" style="display: none;"></span>',"</div>",'<div class="im-btn-container">','<a href="'+this.downAppUrl+'" target="_blank" title="下载APP">'+this.appDesc+"</a>",'<input type="button" value="发送" class="send" data-role="im-input-sendbtn"/>',"</div>","</div>","</div>","</div>",'<div class="lianjiaim-window im-online disabled" data-role="im-bang" style="display: none;">','<div class="lianjiaim-wintitle">',"<i>在线</i>",'<span class="im-wt-name">链家帮帮</span>','<span class="im-wt-time">在线人工服务时间：9:00 - 23:00</span>','<a class="im-wt-closebtn" title="关闭" data-role="bang-close">关闭</a>',"</div>",'<div class="lianjiaim-wincont">','<div class="im-wc-chat bang-chatcontainer" data-role="bang-chatcontainer">','<ul data-role="bang-msgcontainer"></ul>',"</div>",'<div class="im-wc-input">','<div class="im-input-container" data-role="im-input-container">','<textarea placeholder="点击输入您想要咨询的问题…" data-role="bang-textarea"></textarea>','<a class="im-input-insertpic" title="插入图片" data-role="bang-picbtn">插入图片</a>','<input type="file" style="display: none;" accept=".gif,.jpg,.jpeg,.png,.bmp" data-role="bang-picupload"/>',"</div>",'<div class="im-btn-container">','<input type="button" value="发送" class="send" data-role="bang-send"/>','<input type="button" value="结束对话" class="end" data-role="bang-end" style="display: none;"/>',"</div>","</div>","</div>","</div>","</div>",'<div class="lianjiaim-personcard" data-role="im-pcard" style="display: none; top: 9999em; left: 9999em;">','<div class="im-personcard-top clear">','<div class="im-personcard-avatar">','<img src="" alt="" width="78" height="78" data-role="im-pcard-avatar"/>',"</div>",'<div class="im-personcard-detail">','<div class="im-personname-wrap">','<span class="im-personname" data-role="im-pcard-name"></span>','<span class="im-gray" data-role="im-pcard-grade"></span>',"</div>","<div>",'<span class="im-gray">主营商圈：</span>','<span data-role="im-pcard-district"></span>',"</div>","<div>",'<span class="im-gray">所属门店：</span>','<span data-role="im-pcard-store"></span>',"</div>","<div>",'<span class="im-gray">从业年限：</span>','<span data-role="im-pcard-workage"></span>',"</div>","</div>","</div>",'<div class="im-personcard-bottom">',"<table>","<tbody>","<tr>","<td>","<span>累计成交：</span>",'<span class="im-red" data-role="im-pcard-totaldeal"></span>',"</td>","<td>","<span>月总带看：</span>",'<span class="im-red" data-role="im-pcard-monthshow"></span>',"</td>","<td>","<span>好评率：</span>",'<span class="im-red" data-role="im-pcard-praiserate"></span>',"</td>","</tr>","</tbody>","</table>","</div>",'<a class="im-personcard-shopbtn" href="" target="_blank" title="进入店铺" data-role="im-pcard-shoplink">进入店铺</a>',"</div>","</div>"].join("")),
this.nodes={wrap:this.rootnode.find('[data-role="im-wrap"]'),head:this.rootnode.find('[data-role="im-head"]'),title:this.rootnode.find('[data-role="im-title"]'),body:this.rootnode.find('[data-role="im-body"]'),serviceItemContainer:this.rootnode.find('[data-role="im-serviceitem-container"]'),listItemContainer:this.rootnode.find('[data-role="im-listitem-container"]'),noagentContainer:this.rootnode.find('[data-role="im-noagent-container"]'),headUnread:this.rootnode.find('[data-role="im-unread"]'),foldBtn:this.rootnode.find('[data-role="im-foldbtn"]'),talkwindow:this.rootnode.find('[data-role="im-window"]'),talkwindowOfflineName:this.rootnode.find('[data-role="im-window-offlinename"]'),talkwindowChatContainer:this.rootnode.find('[data-role="im-window-chatcontainer"]'),talkwindowMsgContainer:this.rootnode.find('[data-role="im-window-msgcontainer"]'),inputContainer:this.rootnode.find('[data-role="im-input-container"]'),inputTextarea:this.rootnode.find('[data-role="im-input-textarea"]'),inputPicBtn:this.rootnode.find('[data-role="im-input-picbtn"]'),inputPicUpload:this.rootnode.find('[data-role="im-input-picupload"]'),inputSendBtn:this.rootnode.find('[data-role="im-input-sendbtn"]'),errorlogContainer:this.rootnode.find('[data-role="im-errorlog"]'),pcard:this.rootnode.find('[data-role="im-pcard"]'),logTrigger:this.rootnode.find('[data-role="im-logtrigger"]'),talkBang:this.rootnode.find('[data-role="im-bang"]'),talkBangMsgContainer:this.rootnode.find('[data-role="bang-msgcontainer"]'),talkBangTextarea:this.rootnode.find('[data-role="bang-textarea"]'),picBtnBang:this.rootnode.find('[data-role="bang-picbtn"]'),picInputBang:this.rootnode.find('[data-role="bang-picupload"]'),talkBangDownload:this.rootnode.find('[data-role="bang-download"]'),talkBangSend:this.rootnode.find('[data-role="bang-send"]'),talkBangEnd:this.rootnode.find('[data-role="bang-end"]')},this.listItemTemplate=$.template(['<li class="lianjiaim-body-item<% if (!item.user_status) { %> offline<% } %>" data-role="im-listitem-item" data-convid="<%= item.convId %>" data-convtype="<%= item.convType %>" data-agentid="<%= item.id %>" data-msgtime="0">','<div class="im-item-show clear">',"<table>","<tbody>","<tr>",'<td class="im-item-avatar">','<img src="<%= item.avatar %>" alt="" width="40" height="40" data-role="im-listitem-item-avatar"/>','<i data-role="im-listitem-item-newmsg" style="display: none;" data-newmsg="0">0</i>',"</td>",'<td class="im-item-cont">','<span class="name" title="" data-role="im-listitem-item-name"><%= item.name %></span>','<span class="text" title="" data-role="im-listitem-item-text"><%= item.summary %></span>',"</td>","</tr>","</tbody>","</table>",'<div class="im-item-time" data-role="im-listitem-item-time"></div>','<a class="im-item-delbtn" title="删除" data-role="im-listdelbtn">&#215;</a>',"</div>",'<div class="im-item-delete clear">',"<div>",'<span class="title">确定删除？</span>','<span class="cont">删除后将不可恢复</span>',"</div>",'<div class="im-item-delbtnwrap">','<a class="im-btn" title="确定" data-role="im-listdel-confirmbtn">确定</a>','<a class="im-btn" title="取消" data-role="im-listdel-cancelbtn">取消</a>',"</div>","</div>","</li>"].join("")),this.messageNodeTemplate=$.template(['<li class="chat-block clear <%= sendType %>" data-msgtime="<%= timestamp %>" data-msgid="<%= msgid %>" data-role="msgitem">','<div class="chat-avatar">','<a title="<%= user.username %>" data-role="im-window-avatar"><img src="<%= user.avatar %>" alt="<%= user.username %>" width="34" height="34"/></a>',"</div>",'<div class="chat-content">',"<i>&#9660;</i>","<div><%= message.text %></div>","</div>","</li>"].join("")),this.picNodeTemplate=$.template(['<li class="chat-block clear <%= sendType %>" data-msgtime="<%= timestamp %>" data-msgid="<%= msgid %>" data-role="msgitem">','<div class="chat-avatar">','<a title="<%= user.username %>" data-role="im-window-avatar"><img src="<%= user.avatar %>" alt="<%= user.username %>" width="34" height="34"/></a>',"</div>",'<div class="chat-content">',"<i>&#9660;</i>",'<p><a href="<%= pic.url %>" title="<%= pic.desc %>" target="_blank"><img class="chat-msg-pic" src="<%= pic.thumb %>" alt="<%= pic.desc %>" /></a></p>',"</div>","</li>"].join("")),this.housecardNodeTemplate=$.template(['<li class="chat-block clear <%= sendType %>" data-msgtime="<%= timestamp %>" data-msgid="<%= msgid %>" data-role="msgitem">','<div class="chat-avatar">','<a title="<%= user.username %>" data-role="im-window-avatar"><img src="<%= user.avatar %>" alt="<%= user.username %>" width="34" height="34"/></a>',"</div>",'<div class="chat-content">',"<i>&#9660;</i>",'<a class="im-housecard" href="<%= houseinfo.schemeUrl %>" target="_blank" title="<%= houseinfo.houseName %>">','<img src="<%= houseinfo.houseImgUrl %>" alt="<%= houseinfo.houseName %>" width="54" height="54"/>','<span class="im-housecard-detail">','<span class="im-housecard-title"><%= houseinfo.houseName %></span>','<span class="im-housecard-describe"><em><%= houseinfo.houseBedroomCount %>室<%= houseinfo.houseHallCount %>厅</em><em><%= houseinfo.area %>㎡</em><em><%= houseinfo.orientation %></em></span>','<span class="im-housecard-price"><%= (houseinfo.price / 10000) + houseinfo.priceUnit %></span>',"</span>","</a>","</div>","</li>"].join("")),this.chatTimeNodeTemplate=$.template(['<li class="chat-time"><%= time %></li>'].join("")),this.xinfangcardNodeTemplate=$.template(['<li class="chat-block clear <%= sendType %>" data-msgtime="<%= timestamp %>" data-msgid="<%= msgid %>" data-role="msgitem">','<div class="chat-avatar">','<a title="<%= user.username %>" data-role="im-window-avatar"><img src="<%= user.avatar %>" alt="<%= user.username %>" width="34" height="34"/></a>',"</div>",'<div class="chat-content">',"<i>&#9660;</i>",'<a class="im-housecard" href="<%= houseinfo.schemeUrl %>" target="_blank" title="<%= houseinfo.houseName %>">','<img src="<%= houseinfo.buildingImgUrl %>.54x54.jpg" alt="<%= houseinfo.buildingName %>" width="54" height="54"/>','<span class="im-housecard-detail">','<span class="im-housecard-title"><%= houseinfo.buildingName %></span>','<span class="im-housecard-describe"><em><%= houseinfo.area %></em><em class="im-house-type-right"><%= houseinfo.houseType %></em></span>','<span class="im-housecard-price"><%= houseinfo.avgPrice %></span>',"</span>","</a>","</div>","</li>"].join("")),this.zulincardNodeTemplate=$.template(['<li class="chat-block clear <%= sendType %>" data-msgtime="<%= timestamp %>" data-msgid="<%= msgid %>" data-role="msgitem">','<div class="chat-avatar">','<a title="<%= user.username %>" data-role="im-window-avatar"><img src="<%= user.avatar %>" alt="<%= user.username %>" width="34" height="34"/></a>',"</div>",'<div class="chat-content">',"<i>&#9660;</i>",'<a class="im-housecard" href="<%= houseinfo.schemeUrl %>" target="_blank" title="<%= houseinfo.houseName %>">','<img src="<%= houseinfo.buildingImgUrl %>.54x54.jpg" alt="<%= houseinfo.buildingName %>" width="54" height="54"/>','<span class="im-housecard-detail">','<span class="im-housecard-title"><%= houseinfo.buildingName %></span>','<span class="im-housecard-describe"><em><%= houseinfo.area %></em><em class="im-house-type-right"><%= houseinfo.houseType %></em></span>','<span class="im-housecard-price"><%= houseinfo.avgPrice %></span>',"</span>","</a>","</div>","</li>"].join("")),this.bangShowEnd=function(e){e?(a.nodes.talkBangDownload.hide(),a.nodes.talkBangEnd.show()):(a.nodes.talkBangDownload.show(),a.nodes.talkBangEnd.hide()),a.scrollBangWindow("bottom")},this.bangRenderSysMsg=function(e,t){var n=$.template(['<li class="chat-wait">'+e+"</li>"].join("")).render();return t?n:(a.nodes.talkBangMsgContainer.append(n),void a.scrollBangWindow("bottom"))},this.bangRenderMsg=function(e,t,n,i,o){var s=t?"chat-out":"chat-in";e=o?e:_util.httpHtml(e),e=e.replace(/(\/\:\S*\s)/g,function(e){e=$.trim(e);for(var t in sticker)if(e==sticker[t].code)return'<img style="height: 20px;" src="'+a.staticRoot+"/pc/asset/lianjiaIM/img/sticker/"+sticker[t].face+'.gif"/>';return e});var r=a.messageNodeTemplate.render({sendType:[s,n||""].join(" "),timestamp:$.now(),msgid:"0",user:{username:t?this.userData.username||"游客":"链家帮帮",avatar:t?this.userData.avatar||a.staticRoot+"/pc/asset/lianjiaIM/img/imgV2/tourist.png":a.staticRoot+"/pc/asset/lianjiaIM/img/imgV2/icon_serv@2xV2.png"},message:{text:e}});return i?r:(a.nodes.talkBangMsgContainer.append(r),void a.scrollBangWindow("bottom"))},this.bangRenderHistory=function(e){if(e.length){var t=[];e.forEach(function(e,n){var i="",o=!1,s="SN_LJBB"!=e.fromUcid,r=_util.timeFormat(e.sendTime,"deltaTime","YYYY-MM-DD hh:mm");if(e.type==-1&&(i=a.bangRenderMsg(e.payload,s,"",!0),o=!0),99!=e.type||s||(i=a.bangRenderMsg(JSON.parse(e.payload).url,!1,"",!0),o=!0),600==e.type||e.type==-2)try{var c=JSON.parse(e.payload);c.original&&(i=a.bangRenderPic(c,s,!0),o=!0),c.desc&&(i=a.bangRenderSysMsg(c.desc,!0),"object"==typeof c.content&&c.content.message&&(i=a.bangRenderSysMsg(c.content.message,!0),2==c.type&&1==c.content.sessionStatus&&(i=a.bangRenderMsg(c.content.message,!1,"",!0))),o=!0)}catch(e){}o&&t.push(a.bangRenderSysMsg(r,!0)),t.push(i)}),a.nodes.talkBangMsgContainer.prepend(t.join("")),a.scrollBangWindow("bottom")}},this.bangRenderPic=function(e,t,a){var n=['<a href="'+e.original+'" title="图片" target="_blank">','<img class="chat-msg-pic" src="'+e.thumbnail+'" alt="图片" />',"</a>"].join("");return a?this.bangRenderMsg(n,t,"",!0,!0):void this.bangRenderMsg(n,t,"",!1,!0)},this.bangRenderType=function(){var e=["<div>","<p>您好，链家帮帮很高兴为您服务，请选择您咨询的服务类型</p>",'<div class="bang-type">',[{text:"二手房",value:"JNZ001"},{text:"新房",value:"JNZ002"},{text:"房屋租赁",value:"JNZ003"}].map(function(e,t){return'<span data-role="bang-type" data-value="'+e.value+'">'+e.text+"</span>"}).join(""),"</div>","</div>"].join("");this.bangRenderMsg(e,!1,"chat-bang")},this.bangRenderAppraise=function(){var e=['<div class="bang-appraise">','<div class="appraise-title">请您对我的服务做出评价，谢谢。</div>','<div class="appraise-type">',[{name:"reaction",text:"响应时效",value:5},{name:"solved",text:"问题解决",value:5},{name:"attitude",text:"服务态度",value:5}].map(function(e,t){return['<div class="appraise-type-item" data-name="'+e.name+'" data-value="'+e.value+'">','<div class="appraise-text">'+e.text+"</div>",'<div class="appraise-stars">',[1,1,1,1,1].map(function(){return'<span class="appraise-star active"></span>'}).join(""),"</div>",'<div class="appraise-num">5分</div>',"</div>"].join("")}).join(""),"</div>",'<textarea data-role="appraise-textarea" placeholder="请写下您的宝贵意见和建议..." maxlength="120"></textarea>','<div class="appraise-btns">','<span data-role="appraise-btn-cancel" class="appraise-btn-cancel">取消</span>','<span data-role="appraise-btn-submit" class="appraise-btn-submit">确定</span>',"</div>","</div>"].join("");a.bangRenderMsg(e,!1,"chat-bang")},this.scrollBangWindow=function(e){$(".bang-chatcontainer").scrollTop(function(){return $.isNumeric(e)?e:"top"===e?0:a.nodes.talkBangMsgContainer.height()-$(this).height()+100})},this.bangTalkDisable=function(e){a.nodes.talkBang[e?"addClass":"removeClass"]("disabled"),a.scrollBangWindow("bottom")},this.bangInline=function(){a.bangRenderSysMsg("正在为您安排坐席，请稍等..."),a.core.sendTo(a.bangData.conv_id,{type:600,payload:JSON.stringify({type:1,content:{customerId:a.userData.ucid,customerName:a.userData.name,cityCode:a.userData.cityid,customerType:a.userData.code?2:1,skillCode:a.bangData.skillCode}})},function(e){return e?void a.bangShowEnd(!0):(a.bangRenderSysMsg("进线失败"),void a.bangTalkDisable(!0))})},this.bangHangup=function(e,t){a.BangInfoNow={conv_id:a.BangInfoNow.conv_id},a.updateBangInfo(),a.core.sendTo(e,{type:600,payload:JSON.stringify({type:3,content:{hangupType:1}})},function(){t&&t()})},this.housecardReg=/(.*?)http[s]?:\/\/\S+?\.lianjia\.com.*?(ershoufang|chengjiao|zufang)\/(\S+?)\.html[#?=\-\w]*(.*)/i,this.xinfangcardReg=/(.*?)http[s]?:\/\/\S+?\.fang\.lianjia\.com\/loupan\/.*?(\S+?)[\/|?|#][#?=\-\w]*(.*)/i,this.zulincardReg=/(.*?)http[s]?:\/\/\S+?\.zu\.ke\.com\/zufang\/(\w+)\.html[\/|?|#]?[#?=\-\w]*(.*)/i,this.ke_ershouCardReg=/(.*?)http[s]?:\/\/\S+?\.ke\.com\/ershoufang\/(\w+)\.html[\/|?|#]?[#?=\-\w]*(.*)/i,this.isFolding=!0,this.isLoadingHistory=!1,this.currentConvId="",this.lianjiaServiceWindow=null,this.errorlogTimer=0,this.imData={},this.agentData={},this.housecardStat={data:{},check:function(e,t){if(this.data[e]){var a=this.data[e][t]||0,n=(new Date).getTime();return n-a>6048e5}return!0},set:function(e,t){this.data[e]||(this.data[e]={}),this.data[e][t]=(new Date).getTime(),window.localStorage.housecardStat=JSON.stringify(this.data)}},this.housecardStat.data=JSON.parse(window.localStorage.housecardStat||"{}"),this.initMessageList=function(){a.core.on("message",function(e,t,n){function i(e){try{var t=JSON.parse(e.payload),n="";2==t.type&&(n=t.content.message,1==t.content.sessionStatus&&(a.bangRenderSysMsg("进线成功"),a.bangRenderMsg(n)),2==t.content.sessionStatus&&a.bangRenderSysMsg(n),a.isFirstInline&&a.sendUrlBang(),a.bangData.callUuid=t.content.callUuid,a.BangInfoNow.callUuid=t.content.callUuid,a.updateBangInfo(),a.bangTalkDisable(!1),a.isFirstInline=!1),6==t.type&&(a.bangRenderSysMsg(t.content.message),a.bangTalkDisable(!0),4!=t.content.sessionStatus&&(a.BangInfoNow.skillCode="",a.updateBangInfo(),5!=t.content.sessionStatus&&a.bangRenderType()))}catch(e){}}var o={},s=[];$.each(t,function(e,t){o[t.convId]||(o[t.convId]=[]),o[t.convId].push(t)}),$.each(o,function(e,t){e=+e,s.push({convId:e,newMsgList:t})}),s.sort(function(e,t){return e.newMsgList.slice(-1)[0].sendTime-t.newMsgList.slice(-1)[0].sendTime}),$.each(s,function(){var e=this.convId,t=this.newMsgList;a.updateImDataConv(e,"convObj",a.core.convMap[e]),n!==-1&&a.imData[e].convObj.updateDetail(),null===a.imData[e].itemNode&&a.addConvItemNode(a.imData[e].convObj),$.each(t,function(t,n){a.imData[e].msgList.push(n)});var i=a.filterSupportMsg(t),o=i.slice(-1)[0]||{},s=0;e===a.currentConvId?(a.addMsg(i,"btm"),a.scrollWindow("btm")):n!==-1&&$.each(i,function(){this.fromUcid!==a.userData.ucid&&s++}),a.updateConvItemNode(e,{text:a.getMsgSummary(o),time:o.sendTime,newmsgAmount:"+"+s},n!==-1)});var r=[],c=[],d=0;if(n==-1){if(a.bangData.conv_id)if(2==t.length){var l=t[1];i(l)}else r=t.filter(function(e,t){return e.convId==a.bangData.conv_id});else if(2==t.length)i(l);else{var u=t.filter(function(e){return"SN_LJBB"===e.fromUcid});u.length&&(r=t.filter(function(e,t){return e.convId==u[0].convId}))}a.bangRenderHistory(r)}else c=t.filter(function(e){return"SN_LJBB"===e.fromUcid}),d=+a.nodes.serviceItemContainer.find('[data-role="im-listitem-item-newmsg"]').attr("data-newmsg")+c.length,a.bangData.conv_id&&"none"===a.nodes.talkBang.css("display")?a.nodes.serviceItemContainer.find('[data-role="im-listitem-item-newmsg"]').attr("data-newmsg",d).text(d)[d?"show":"hide"]():a.nodes.serviceItemContainer.find('[data-role="im-listitem-item-newmsg"]').attr("data-newmsg",0).text(0).hide(),c.forEach(function(e){if(a.bangData.skillCode){if(a.bangMsgList[e.sendTime]==e.payload)return!1;if(a.bangMsgList[e.sendTime]=e.payload,e&&a.bangData.conv_id)try{var t=JSON.parse(e.payload),n="";"object"!=typeof t&&a.bangRenderMsg(t,!1),e.type==-2&&a.bangRenderPic(t,!1),99==e.type&&a.bangRenderMsg(t.url,!1,"",!1),2==t.type&&(n=t.content.message,1==t.content.sessionStatus&&(a.bangRenderSysMsg("进线成功"),a.bangRenderMsg(n)),2==t.content.sessionStatus&&a.bangRenderSysMsg(n),a.isFirstInline&&a.sendUrlBang(),a.bangData.callUuid=t.content.callUuid,a.BangInfoNow.callUuid=t.content.callUuid,a.updateBangInfo(),a.bangTalkDisable(!1),a.isFirstInline=!1),3==t.type&&(n=t.desc,a.bangTalkDisable(!0),a.bangRenderSysMsg("<span>"+n+'</span><span class="btn-handle" data-role="inline-again">重新进线</span>'),a.bangRenderAppraise(),a.BangInfoNow={conv_id:a.BangInfoNow.conv_id},a.updateBangInfo()),4==t.type&&3==t.content.sessionStatus&&(a.bangTalkDisable(!0),a.BangInfoNow={conv_id:a.BangInfoNow.conv_id},a.updateBangInfo(),a.bangRenderSysMsg('<span>会话已结束</span><span class="btn-handle" data-role="inline-again">重新进线</span>')),6==t.type&&(a.bangRenderSysMsg(t.content.message),a.bangTalkDisable(!0),4!=t.content.sessionStatus&&(a.BangInfoNow.skillCode="",a.updateBangInfo(),5!=t.content.sessionStatus&&a.bangRenderType())),7==t.type&&(5==t.content.status&&a.bangRenderSysMsg(t.content.message),6==t.content.status&&a.bangRenderSysMsg("<span>"+t.content.message+'</span><a class="btn-handle" target="_blank" href="http://cconline.netapi.lianjia.com/webchat/callback.html?lianjiaCity='+window.ljConf.city_id+'">预约呼叫</a>'),7==t.content.status&&a.bangRenderSysMsg(t.content.message))}catch(t){var n=e.payload;a.bangRenderMsg(n,!1)}}});a.updateHeadUnread()})},this.userData.code?(a.core=new ImCore({msgApiRoot:apiRoot.imApi.msg,mediaApiRoot:apiRoot.imApi.media,apiheader:a.header,appkey:e.appkey,ucid:a.userData.ucid}),this.getUcData(this.userData.ucid,function(t){var n=t[0]||{};a.userData=$.extend({ucid:n.uc_id,name:n.name,avatar:n.favicon,type:n.type},a.userData),a.core=new ImCore({msgApiRoot:apiRoot.imApi.msg,mediaApiRoot:apiRoot.imApi.media,apiheader:a.header,appkey:e.appkey,ucid:a.userData.ucid}),a.core.on("init",function(t){$.each(a.core.convMap,function(e,t){e=+e,a.updateImDataConv(e,"convObj",t),a.updateImDataConv(e,"readMsgId",t.readMsgId)}),a.nodes.listItemContainer.on("click",'[data-role="im-listitem-item"]',function(){a.clickConvItemTrck();var t=$(this).attr("data-convid"),n=$(this).attr("data-agentid"),i=$(this).attr("data-convtype");"function"==typeof e.userTrack&&e.userTrack({event:"convClick",convId:t,agentId:n,convType:i}),a.currentConvId!==t&&(a.setWindow(t),a.showWindow(!0))}),a.nodes.talkwindow.on("click",'[data-role="im-window-closebtn"]',function(){a.currentConvId="",a.showWindow(!1)}),a.nodes.inputSendBtn.on("click",function(){""===a.currentConvId||a.nodes.inputSendBtn.prop("disabled")||(a.nodes.inputSendBtn.val("发送中...").prop({disabled:!0}),a.sendMsg(a.currentConvId,a.nodes.inputTextarea.val(),function(e){a.nodes.inputSendBtn.val("发送").prop({disabled:!1}),$.isEmptyObject(e)?a.showErrorlog("消息发送失败"):a.nodes.inputTextarea.val("")})),"function"==typeof e.userTrack&&e.userTrack({event:"clickSend",convId:a.currentConvId,content:a.nodes.inputTextarea.val()})}),a.nodes.inputTextarea.on("keydown",function(e){13===e.keyCode&&e.ctrlKey===!1&&(e.preventDefault(),a.nodes.inputSendBtn.trigger("click"))}),a.nodes.inputPicBtn.on("click",function(){a.nodes.inputPicUpload.trigger("click")}),a.nodes.inputPicUpload.on("change",function(e){a.sendPic(a.currentConvId,a.nodes.inputPicUpload[0].files[0],function(e){$.isEmptyObject(e)&&a.showErrorlog("图片发送失败")})}),a.nodes.talkwindowChatContainer.on("scroll",function(){a.loadHist()}),function(){var e=!1,t=function(){setTimeout(function(){e&&a.nodes.pcard.stop().fadeOut(100,function(){a.nodes.pcard.css({top:"9999em",left:"9999em"})})},100)};a.nodes.talkwindow.on("mouseenter",'.chat-in [data-role="im-window-avatar"]',function(){e=!1;var t=$(this),n=a.agentData[a.imData[a.currentConvId].convObj.peer.ucid];n&&(a.updatePcard(n),a.nodes.pcard.css({top:t.position().top-t.height()/2+13+a.nodes.talkwindowMsgContainer.position().top,left:t.position().left+t.width()/2+a.nodes.talkwindowMsgContainer.position().left}).stop().fadeIn(100))}).on("mouseleave",'.chat-in [data-role="im-window-avatar"]',function(){e=!0,t()}),a.nodes.pcard.on("mouseenter",function(){e=!1}).on("mouseleave",function(){e=!0,t()})}(),a.renderConvList()}),a.initMessageList(),a.imBaseInteractiveInit(e),a.core.initialize()})):this.imBaseInteractiveInit(e),t&&t()}$.template=function(){var rsplit=function(e,t){for(var a,n,i,o=t.exec(e),s=new Array;null!=o;)a=o.index,n=t.lastIndex,0!=a&&(i=e.substring(0,a),s.push(e.substring(0,a)),e=e.slice(a)),s.push(o[0]),e=e.slice(o[0].length),o=t.exec(e);return""==!e&&s.push(e),s},chop=function(e){return e.substr(0,e.length-1)},extend=function(e,t){for(var a in t)t.hasOwnProperty(a)&&(e[a]=t[a])},EJS=function(e){if(e="string"==typeof e?{view:e}:e,this.set_options(e),e.precompiled)return this.template={},this.template.process=e.precompiled,void EJS.update(this.name,this);if(e.element){if("string"==typeof e.element){var t=e.element;if(e.element=document.getElementById(e.element),null==e.element)throw t+"does not exist!"}e.element.value?this.text=e.element.value:this.text=e.element.innerHTML,this.name=e.element.id,this.type="["}else if(e.url){e.url=EJS.endExt(e.url,this.extMatch),this.name=this.name?this.name:e.url;var a=e.url,n=EJS.get(this.name,this.cache);if(n)return n;if(n==EJS.INVALID_PATH)return null;try{this.text=EJS.request(a+(this.cache?"":"?"+Math.random()))}catch(e){}if(null==this.text)throw{type:"EJS",message:"There is no template at "+a}}var n=new EJS.Compiler(this.text,this.type);n.compile(e,this.name),EJS.update(this.name,this),this.template=n};return EJS.prototype={render:function(e,t){e=e||{},this._extra_helpers=t;var a=new EJS.Helpers(e,t||{});return this.template.process.call(e,e,a)},update:function(element,options){return"string"==typeof element&&(element=document.getElementById(element)),null==options?(_template=this,function(e){EJS.prototype.update.call(_template,element,e)}):void("string"==typeof options?(params={},params.url=options,_template=this,params.onComplete=function(request){var object=eval(request.responseText);EJS.prototype.update.call(_template,element,object)},EJS.ajax_request(params)):element.innerHTML=this.render(options))},out:function(){return this.template.out},set_options:function(e){this.type=e.type||EJS.type,this.cache=null!=e.cache?e.cache:EJS.cache,this.text=e.text||null,this.name=e.name||null,this.ext=e.ext||EJS.ext,this.extMatch=new RegExp(this.ext.replace(/\./,"."))}},EJS.endExt=function(e,t){return e?(t.lastIndex=0,e+(t.test(e)?"":this.ext)):null},EJS.Scanner=function(e,t,a){extend(this,{left_delimiter:t+"%",right_delimiter:"%"+a,double_left:t+"%%",double_right:"%%"+a,left_equal:t+"%=",left_comment:t+"%#"}),this.SplitRegexp="["==t?/(\[%%)|(%%\])|(\[%=)|(\[%#)|(\[%)|(%\]\n)|(%\])|(\n)/:new RegExp("("+this.double_left+")|(%%"+this.double_right+")|("+this.left_equal+")|("+this.left_comment+")|("+this.left_delimiter+")|("+this.right_delimiter+"\n)|("+this.right_delimiter+")|(\n)"),this.source=e,this.stag=null,this.lines=0},EJS.Scanner.to_text=function(e){return null==e||void 0===e?"":e instanceof Date?e.toDateString():e.toString?e.toString():""},EJS.Scanner.prototype={scan:function(e){if(scanline=this.scanline,regex=this.SplitRegexp,""==!this.source)for(var t=rsplit(this.source,/\n/),a=0;a<t.length;a++){var n=t[a];this.scanline(n,regex,e)}},scanline:function(e,t,a){this.lines++;for(var n=rsplit(e,t),i=0;i<n.length;i++){var o=n[i];if(null!=o)try{a(o,this)}catch(e){throw{type:"EJS.Scanner",line:this.lines}}}}},EJS.Buffer=function(e,t){this.line=new Array,this.script="",this.pre_cmd=e,this.post_cmd=t;for(var a=0;a<this.pre_cmd.length;a++)this.push(e[a])},EJS.Buffer.prototype={push:function(e){this.line.push(e)},cr:function(){this.script=this.script+this.line.join("; "),this.line=new Array,this.script=this.script+"\n"},close:function(){if(this.line.length>0){for(var e=0;e<this.post_cmd.length;e++)this.push(pre_cmd[e]);this.script=this.script+this.line.join("; "),line=null}}},EJS.Compiler=function(e,t){this.pre_cmd=["var ___ViewO = [];"],this.post_cmd=new Array,this.source=" ",null!=e&&("string"==typeof e?(e=e.replace(/\r\n/g,"\n"),e=e.replace(/\r/g,"\n"),this.source=e):e.innerHTML&&(this.source=e.innerHTML),"string"!=typeof this.source&&(this.source="")),t=t||"<";var a=">";switch(t){case"[":a="]";break;case"<":break;default:throw t+" is not a supported deliminator"}this.scanner=new EJS.Scanner(this.source,t,a),this.out=""},EJS.Compiler.prototype={compile:function(options,name){options=options||{},this.out="";var put_cmd="___ViewO.push(",insert_cmd=put_cmd,buff=new EJS.Buffer(this.pre_cmd,this.post_cmd),content="",clean=function(e){return e=e.replace(/\\/g,"\\\\"),e=e.replace(/\n/g,"\\n"),e=e.replace(/"/g,'\\"')};this.scanner.scan(function(e,t){if(null==t.stag)switch(e){case"\n":content+="\n",buff.push(put_cmd+'"'+clean(content)+'");'),buff.cr(),content="";break;case t.left_delimiter:case t.left_equal:case t.left_comment:t.stag=e,content.length>0&&buff.push(put_cmd+'"'+clean(content)+'")'),content="";break;case t.double_left:content+=t.left_delimiter;break;default:content+=e}else switch(e){case t.right_delimiter:switch(t.stag){case t.left_delimiter:"\n"==content[content.length-1]?(content=chop(content),buff.push(content),buff.cr()):buff.push(content);break;case t.left_equal:buff.push(insert_cmd+"(EJS.Scanner.to_text("+content+")))")}t.stag=null,content="";break;case t.double_right:content+=t.right_delimiter;break;default:content+=e}}),content.length>0&&buff.push(put_cmd+'"'+clean(content)+'")'),buff.close(),this.out=buff.script+";";var to_be_evaled="/*"+name+"*/this.process = function(_CONTEXT,_VIEW) { try { with(_VIEW) { with (_CONTEXT) {"+this.out+" return ___ViewO.join('');}}}catch(e){e.lineNumber=null;throw e;}};";try{eval(to_be_evaled)}catch(e){if("undefined"==typeof JSLINT)throw e;JSLINT(this.out);for(var i=0;i<JSLINT.errors.length;i++){var error=JSLINT.errors[i];if("Unnecessary semicolon."!=error.reason){error.line++;var e=new Error;throw e.lineNumber=error.line,e.message=error.reason,options.view&&(e.fileName=options.view),e}}}}},EJS.config=function(e){EJS.cache=null!=e.cache?e.cache:EJS.cache,EJS.type=null!=e.type?e.type:EJS.type,EJS.ext=null!=e.ext?e.ext:EJS.ext;var t=EJS.templates_directory||{};EJS.templates_directory=t,EJS.get=function(e,a){return 0==a?null:t[e]?t[e]:null},EJS.update=function(e,a){null!=e&&(t[e]=a)},EJS.INVALID_PATH=-1},EJS.config({cache:!0,type:"<",ext:".ejs"}),EJS.Helpers=function(e,t){this._data=e,this._extras=t,extend(this,t)},EJS.Helpers.prototype={view:function(e,t,a){return a||(a=this._extras),t||(t=this._data),new EJS(e).render(t,a)},to_text:function(e,t){return null==e||void 0===e?t||"":e instanceof Date?e.toDateString():e.toString?e.toString().replace(/\n/g,"<br />").replace(/''/g,"'"):""}},EJS.newRequest=function(){for(var e=[function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new XMLHttpRequest},function(){return new ActiveXObject("Microsoft.XMLHTTP")}],t=0;t<e.length;t++)try{var a=e[t]();if(null!=a)return a}catch(e){continue}},EJS.request=function(e){var t=new EJS.newRequest;t.open("GET",e,!1);try{t.send(null)}catch(e){return null}return 404==t.status||2==t.status||0==t.status&&""==t.responseText?null:t.responseText},EJS.ajax_request=function(e){e.method=e.method?e.method:"GET";var t=new EJS.newRequest;t.onreadystatechange=function(){4==t.readyState&&(200==t.status?e.onComplete(t):e.onComplete(t))},t.open(e.method,e.url),t.send(null)},function(e){return new EJS({text:e,type:"<"})}}(),$.Trans=_Trans(),$.EventEmitter=_EventEmitter(),window.LJMessenger=function(){function e(e,t){var a="";if(arguments.length<2?a="target error - target and name are both requied":"object"!=typeof e?a="target error - target itself must be window object":"string"!=typeof t&&(a="target error - target name must be string type"),a)throw new Error(a);this.target=e,this.name=t}function t(e,t){this.targets={},this.name=e,this.listenFunc=[],a=t||a,"string"!=typeof a&&(a=a.toString()),this.initListen()}var a="[LIANJIA_Messenger_CROSS]",n="postMessage"in window;return n?e.prototype.send=function(e){this.target.postMessage(a+e,"*")}:e.prototype.send=function(e){var t=window.navigator[a+this.name];if("function"!=typeof t)throw new Error("target callback function is not defined");t(a+e,window)},t.prototype.addTarget=function(t,a){var n=new e(t,a);this.targets[a]=n},t.prototype.initListen=function(){var e=this,t=function(t){if("object"==typeof t&&t.data&&(t=t.data),t&&"string"==typeof t&&t.indexOf(a)>=0){t=t.slice(a.length);for(var n=0;n<e.listenFunc.length;n++)e.listenFunc[n](t)}};n?"addEventListener"in document?window.addEventListener("message",t,!1):"attachEvent"in document&&window.attachEvent("onmessage",t):window.navigator[a+this.name]=t},t.prototype.listen=function(e){this.listenFunc.push(e)},t.prototype.clear=function(){this.listenFunc=[]},t.prototype.send=function(e){var t,a=this.targets;for(t in a)a.hasOwnProperty(t)&&a[t].send(e)},t}(),$.parseURL&&"[object Function]"===Object.prototype.toString.call($.parseURL)||($.parseURL=function(e){if(!e)return null;for(var t=/^((?:([A-Za-z]+):(\/{0,3}))?([0-9.\-A-Za-z]+\.[0-9A-Za-z]+)?(?::(\d+))?)(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/,a=["url","origin","scheme","slash","host","port","path","query","hash"],n=t.exec(e),i={},o=0,s=a.length;s>o;o+=1)i[a[o]]=n[o]||"";return i});var sticker=_sticker,$win=$(window),$body=$(document.body),apiRoot=function(){for(var e=window.location,t=e.host,a=["dev","test"],n=null;(n=a.pop())&&!(t.indexOf(n)>=0););n||(n="prod");var i={dev:"http://ajax.testapi.lianjia.com:7081/",test:"http://ajax.testapi.lianjia.com/",prod:"//ajax.api.lianjia.com/"},o={dev:{msg:"https://imapi-test.lianjia.com",media:"https://imm-test.lianjia.com"},test:{msg:"https://imapi-test.lianjia.com",media:"https://imm-test.lianjia.com"},prod:{msg:"https://imapi.lianjia.com",media:"https://imm.lianjia.com"}},s={dev:"http://imscheduler.sinan.off.test.lianjia.com:10103/webchat/satisfaction",test:"http://imscheduler.sinan.off.test.lianjia.com:10103/webchat/satisfaction",prod:"https://ajax.api.lianjia.com/web/remark/satisfaction"},r={dev:"http://10.30.128.254:8050/",test:"http://testbj.fang.lianjia.com/",prod:"//bj.fang.lianjia.com/"},c={dev:"http://10.30.129.193:9002/",test:"http://testapi.zufangzi.com/",prod:"//api.zufangzi.com/"},d={dev:"http://10.30.129.109:8058/",test:"//test-i.bk-house-api.ke.com/",prod:"//bk-house-api.ke.com/"};return{ljApi:i[n],imApi:o[n],satisfaction:s[n],xfApi:r[n],zulinApi:c[n],ke_ershouApi:d[n]}}(),_util={noop:function(){},pad:function(e){return("0"+e).slice(-2)},httpHtml:function(e){var t=/(http:\/\/|https:\/\/)((\w|=|\?|\.|\/|&|-)+)/g;return e.replace(t,'<a href="$1$2" target="_blank">$1$2</a>')},timeFormat:function(e,t,a){var n=new Date(e),i=n.getFullYear()+"",o=this.pad(n.getMonth()+1),s=this.pad(n.getDate()),r=this.pad(n.getHours()),c=this.pad(n.getMinutes()),d=this.pad(n.getSeconds()),l="";switch(t){case"deltaTime":var u=new Date;l=n.getFullYear()===u.getFullYear()&&n.getMonth()===u.getMonth()&&n.getDate()===u.getDate()?r+":"+c:u.getTime()-n.getTime()<864e5?"昨天 "+r+":"+c:a.replace(/YYYY/g,i).replace(/MM/g,o).replace(/DD/g,s).replace(/hh/g,r).replace(/mm/g,c).replace(/ss/g,d);break;default:l=t.replace(/YYYY/g,i).replace(/MM/g,o).replace(/DD/g,s).replace(/hh/g,r).replace(/mm/g,c).replace(/ss/g,d)}return l},getCookie:function(e){if(document.cookie.length>0){var t=document.cookie.indexOf(e+"="),a=0;if(t!=-1)return t=t+e.length+1,a=document.cookie.indexOf(";",t),a==-1&&(a=document.cookie.length),decodeURI(document.cookie.substring(t,a))}return""},setCookie:function(e,t,a){var n=new Date;n.setDate(n.getDate()+a),document.cookie=e+"="+encodeURI(t)+(null==a?"":";expires="+n.toUTCString())},apiUrl:function(e){return apiRoot.ljApi+e},xinfangUrl:function(e){return apiRoot.xfApi+e},zulinUrl:function(e){return apiRoot.zulinApi+e},ke_ershouUrl:function(e){return apiRoot.ke_ershouApi+e},imApiUrl:function(e){return apiRoot.imApi.msg+e}};return window.__lianjiaIMVersion="链接 + 表情",LianjiaIM.prototype={constructor:LianjiaIM,updateConfigs:function(e){this.login=e.login||this.login,this.token=e.token||this.token,this.is_ljbb=e.is_ljbb,this.header={"Lianjia-Im-Protocal-Version":"1.1","Lianjia-App-Id":e.appid||this.header["Lianjia-App-Id"],"Lianjia-Access-Token":e.token||this.header["Lianjia-Access-Token"]||"1","Lianjia-Device-Id":_util.getCookie("lianjia_uuid")},this.userData=$.extend({uuid:_util.getCookie("lianjia_uuid"),cityid:_util.getCookie("select_city")},e.userData||{}),this.userData.code||(this.userData=$.extend({ucid:_util.getCookie("lianjia_uuid"),name:"游客",avatar:"",type:1},this.userData))},clickConvItemTrck:function(){return this.core?(this.core.port="im_convlist",void(this.core.extAttr=null)):(console.log("not login"),!1)},createTalkTrack:function(e,t){return this.core?(this.core.port=e,
void(t&&(this.core.extAttr="string"==typeof t?JSON.parse(t):t))):(console.log("not login"),!1)},imBaseInteractiveInit:function(e){var t=this;t.nodes.serviceItemContainer.on("click",function(a){a.preventDefault(),t.showBang(!0,!0),t.nodes.serviceItemContainer.find('[data-role="im-listitem-item-newmsg"]').attr("data-newmsg",0).text(0).hide(),t.updateHeadUnread(),t.firstInitMessageList&&(t.firstInitMessageList=!1,t.bangData.conv_id?(t.userData.code||(t.header["Lianjia-Uuid"]=t.userData.ucid,t.core=new ImCore({msgApiRoot:apiRoot.imApi.msg,mediaApiRoot:apiRoot.imApi.media,apiheader:t.header,appkey:t.pageConf.appkey,ucid:t.userData.ucid}),t.initMessageList(),t.core.initialize()),t.bangData.skillCode?(t.bangTalkDisable(!1),t.bangShowEnd(!0)):(t.bangRenderType(),t.bangTalkDisable(!0),t.bangShowEnd(!0))):t.userData.code?t.core.create(["SN_LJBB"],3,function(e){return $.isEmptyObject(e)?void t.bangRenderSysMsg("会话创建失败"):(t.bangData.conv_id=e.id,t.BangInfoNow={conv_id:e.id},t.updateBangInfo(),t.bangRenderType(),void t.initMessageList())}):(t.header["Lianjia-Uuid"]=t.userData.ucid,t.core=new ImCore({msgApiRoot:apiRoot.imApi.msg,mediaApiRoot:apiRoot.imApi.media,apiheader:t.header,appkey:t.pageConf.appkey,ucid:t.userData.ucid}),t.core.create(["SN_LJBB"],3,function(e){return $.isEmptyObject(e)?void t.bangRenderSysMsg("会话创建失败"):(t.bangData.conv_id=e.id,t.BangInfoNow={conv_id:e.id},t.updateBangInfo(),t.bangRenderType(),t.initMessageList(),void t.core.initialize())})),t.clickConvItemTrck(),"function"==typeof e.userTrack?(e.userTrack({ljweb_mod:"bangbangclick",ljweb_bl:t.userData.code?"1":"0",ljweb_el:"BB120",ljweb_group:1}),e.userTrack({ljweb_mod:"bangbangclick",ljweb_bl:t.userData.code?"1":"0",ljweb_el:"BB120",ljweb_group:1})):(window.LjUserTrack&&LjUserTrack.send&&LjUserTrack.send({ljweb_mod:"bangbangclick",ljweb_bl:t.userData.code?"1":"0",ljweb_el:"BB120",ljweb_group:1}),window.LjUserTrack&&LjUserTrack.send&&LjUserTrack.send({ljweb_mod:"bangbangclick",ljweb_bl:t.userData.code?"1":"0",ljweb_el:"BB120",ljweb_group:1,evt_id:"10190"})))}),t.nodes.talkBangMsgContainer.on("click",'[data-role="bang-type"]',function(){var e=$(this).closest(".chat-block");if(!e.hasClass("disabled")){e.addClass("disabled");var a=$(this).data("value"),n=$(this).text();t.bangData.skillCode=a,t.BangInfoNow.skillCode=a,t.updateBangInfo(),t.bangRenderMsg(n,!0),t.bangInline()}}).on("click",'[data-role="inline-again"]',function(){var e=$(this).closest(".chat-wait");e.hasClass("disabled")||(e.addClass("disabled"),t.bangRenderType())}),t.sendUrlBang=function(){var e=window.location.href;if(null!==e.match(t.housecardReg)){var a=e.replace(t.housecardReg,"$3");t.getHouseCard(a,function(e){t.core.sendTo(t.bangData.conv_id,{type:1,payload:JSON.stringify(e)},function(e){})},function(){})}else if(null!==e.match(t.xinfangcardReg)){var n=e.replace(t.xinfangcardReg,"$2");t.getXinfangCard(n,function(e){t.core.sendTo(t.bangData.conv_id,{type:6,payload:JSON.stringify(e)},function(e){})},function(){})}else t.core.sendTo(t.bangData.conv_id,{type:99,payload:JSON.stringify({title:"",content:"",url:window.location.href,coverUrl:""})},function(e){})},t.nodes.talkBangMsgContainer.on("mouseenter mouseleave click",".appraise-star",function(e){function t(e){e=e||5,i.text(e+"分"),n.removeClass("active").slice(0,e).addClass("active")}var a=$(this).closest(".appraise-type-item"),n=a.find(".appraise-star"),i=a.find(".appraise-num"),o=(a.attr("data-value")||5,+$(this).index()+1);"click"==e.type?(a.attr("data-value",o),t(o)):t("mouseenter"==e.type?o:a.attr("data-value"))}),t.nodes.talkBangMsgContainer.on("click",".appraise-btn-submit",function(e){$(this).closest(".bang-appraise").addClass("disabled");var a={callUuid:t.bangData.callUuid};t.nodes.talkBangMsgContainer.find(".appraise-type-item").each(function(e,t){var n=$(this).attr("data-name"),i=$(this).attr("data-value");a[n]=i});var n=$.trim(t.nodes.talkBangMsgContainer.find('[data-role="appraise-textarea"]').val());n&&(a.suggest=n.slice(0,120)),t.nodes.talkBangMsgContainer.find(".bang-appraise").closest("li").remove(),t.bangRenderMsg("感谢您的评价反馈，链家网将会越来越好。"),$.post(apiRoot.satisfaction,a)}),t.nodes.talkBangMsgContainer.on("click",".appraise-btn-cancel",function(e){t.nodes.talkBangMsgContainer.find(".bang-appraise").closest("li").remove(),t.bangRenderMsg("您已取消服务评价")}),t.nodes.talkBangTextarea.on("keydown",function(e){13===e.keyCode&&e.ctrlKey===!1&&(e.preventDefault(),t.nodes.talkBangSend.trigger("click"))}),t.nodes.talkBangSend.on("click",function(){var e=$.trim(t.nodes.talkBangTextarea.val());e&&(t.nodes.talkBangSend.val("发送中...").prop({disabled:!0}),t.sendMsg(t.bangData.conv_id,e,function(a){t.nodes.talkBangSend.val("发送").prop({disabled:!1}),t.nodes.talkBangTextarea.val(""),t.bangRenderMsg(e,!0)}))}),t.nodes.talkBangEnd.on("click",function(e){t.bangTalkDisable(!0),t.bangHangup(t.bangData.conv_id,function(){t.bangRenderSysMsg('<span>您挂断了通话</span><span class="btn-handle" data-role="inline-again">重新进线</span>'),t.bangRenderAppraise()})}),t.nodes.picBtnBang.on("click",function(){t.nodes.picInputBang.trigger("click")}),t.nodes.picInputBang.on("change",function(e){t.sendPic(t.bangData.conv_id,t.nodes.picInputBang[0].files[0],function(e){if(e){var a=JSON.parse(e.payload);t.bangRenderPic(a,!0)}else t.bangRenderSysMsg("图片发送失败")})}),$body.on("click.lianjiaim",'a[data-role="lianjiaim-createtalk"]',function(a){a.preventDefault();var n=$(this);t.initTalk(n.attr("data-ucid"),n.data("source-port")),t.createTalkTrack(n.data("source-port"),n.data("source-extends")),"function"==typeof e.userTrack?(e.userTrack({ljweb_mod:"imclick",ljweb_bl:t.userData.code?"1":"0",ljweb_el:n.attr("data-ucid"),ljweb_group:1}),e.userTrack({ljweb_mod:"imclick",ljweb_bl:t.userData.code?"1":"0",ljweb_el:n.attr("data-ucid"),ljweb_group:1,evt_id:"10190"})):(window.LjUserTrack&&LjUserTrack.send&&LjUserTrack.send({ljweb_mod:"imclick",ljweb_bl:t.userData.code?"1":"0",ljweb_el:n.attr("data-ucid"),ljweb_group:1}),window.LjUserTrack&&LjUserTrack.send&&LjUserTrack.send({ljweb_mod:"imclick",ljweb_bl:t.userData.code?"1":"0",ljweb_el:n.attr("data-ucid"),ljweb_group:1,evt_id:"10190"}))}),$body.append(this.rootnode),this.nodes.head.on("click",function(a){"function"==typeof e.userTrack&&e.userTrack({event:"openIm",target:t.isFolding}),t.fold(!t.isFolding)}),t.nodes.talkBang.on("click",'[data-role="bang-close"]',function(){t.currentConvId="",t.showBang(!1)})},getUcData:function(e,t){t=t||_util.noop,"string"==typeof e&&(e=[e]),this.core.getUsersInfo({ucids:e.join(",")},t)},filterSupportMsg:function(e){var t=[],a=[-1,-2,-6,1,2,3,7,5,6,99,8,105,109,211,310,320,330,120,121,600,122,123,124,125,804];return $.each(e,function(){var e=this;a.some(function(t){return t===e.type})&&t.push(e)}),t},getMsgSummary:function(e){var t="";if(e)switch(e.type){case-1:t=e.payload;break;case-2:t="[图片]";break;case 105:t="[自动回复]"+e.payload;break;case 109:t="["+(JSON.parse(e.payload).emoticonName||"表情")+"]";break;case 1:t="[房源]";break;case 6:t="[楼盘]"}return t},initTalk:function(e){var t=this,a=arguments,n="",i="",o="";if(!this.userData.code)return void(this.login&&"[object Function]"===Object.prototype.toString.call(this.login)?this.login():"undefined"!=typeof login?login.openLoginDialog&&login.openLoginDialog():alert("请先登录再开始聊天！"));var s=Object.prototype.toString.call(a[0]);"[object Object]"===s?(n=e.ucid||"",i=e.port||"",o=e.msgPayload,this.core&&(this.core.extAttr=JSON.parse(e.extends||"null"))):"[object String]"===s&&(n=a[0]||"",i=a[1]||"im",this.core&&(this.core.extAttr=JSON.parse(a[2]||"null"))),n!==this.userData.ucid&&""!==n&&(this.core&&(this.core.port=i),this.core&&this.core.create(n,1,function(e){if(null!==e){if(t.updateImDataConv(e.id,"convObj",e),null===t.imData[e.id].itemNode&&t.addConvItemNode(t.imData[e.id].convObj),t.fold(!1),t.setWindow(e.id),t.showWindow(!0),t.scrollWindow("btm"),o&&t.sendMsg(e.id,o,function(e){$.isEmptyObject(e)&&t.showErrorlog("消息发送失败")}),null!==window.location.href.match(t.housecardReg)){var a=window.location.href.replace(t.housecardReg,"$3");t.housecardStat.check(n,a)&&t.sendMsg(e.id,window.location.href,function(e){t.housecardStat.set(n,a),$.isEmptyObject(e)&&t.showErrorlog("消息发送失败")},!1,1)}if(null!==window.location.href.match(t.xinfangcardReg)){var i=window.location.href.replace(t.xinfangcardReg,"$2");t.housecardStat.check(n,i)&&t.sendMsg(e.id,window.location.href,function(e){t.housecardStat.set(n,i),$.isEmptyObject(e)&&t.showErrorlog("消息发送失败")})}if(null!==window.location.href.match(t.zulincardReg)){var s=window.location.href.replace(t.zulincardReg,"$2");t.housecardStat.check(n,s)&&t.sendMsg(e.id,window.location.href,function(e){t.housecardStat.set(n,s),$.isEmptyObject(e)&&t.showErrorlog("消息发送失败")})}if(null!==window.location.href.match(t.ke_ershouCardReg)){var r=window.location.href.replace(t.ke_ershouCardReg,"$2");t.housecardStat.check(n,r)&&t.sendMsg(e.id,window.location.href,function(e){t.housecardStat.set(n,r),$.isEmptyObject(e)&&t.showErrorlog("消息发送失败")})}}else t.showErrorlog("会话创建失败")}))},sendMsg:function(e,t,a,n,i){a=a||_util.noop;var o=this;if($.trim(t).length>0)if(n||null===t.match(this.housecardReg))if(n||null===t.match(o.xinfangcardReg))if(n||null===t.match(o.zulincardReg))if(n||null===t.match(o.ke_ershouCardReg)){var s=t,r=null;s.length>500&&(s=t.slice(0,500),r=t.slice(500)),this.core.sendTo(e,{type:-1,localId:+new Date,payload:this.core.encodeHtml(s)},function(t){null!==r?o.sendMsg(e,r,a):a(t)})}else{var c=t.match(o.ke_ershouCardReg),d={oriMsg:t,beforeMsg:c[1]||"",house_code:c[2]||"",afterMsg:c[3]||""};this.sendKeErshouCard(e,d,a)}else{var c=t.match(o.zulincardReg),d={oriMsg:t,beforeMsg:c[1]||"",house_code:c[2]||"",afterMsg:c[3]||""};this.sendZulincard(e,d,a)}else{var l={oriMsg:t,beforeMsg:t.replace(o.xinfangcardReg,"$1"),project_name:t.replace(o.xinfangcardReg,"$2"),afterMsg:t.replace(o.xinfangcardReg,"$3")};this.sendXinfangcard(e,l,a,i)}else{var d={oriMsg:t,beforeMsg:t.replace(this.housecardReg,"$1"),houseType:t.replace(this.housecardReg,"$2"),houseCode:t.replace(this.housecardReg,"$3"),afterMsg:t.replace(this.housecardReg,"$4")};this.sendHousecard(e,d,a)}else a({noSend:!0})},sendPic:function(e,t,a){a=a||_util.noop,this.core.uploadPicture(e,t,function(t,n){n.sendTo(e,{type:-2,payload:t},function(e){a(e)})})},sendHousecardMsg:function(e,t,a){a=a||_util.noop,this.core.sendTo(e,{type:1,localId:+new Date,payload:JSON.stringify(t)},function(e){a(e)})},sendHousecard:function(e,t,a){a=a||_util.noop;var n=this;n.getHouseCard(t.houseCode,function(i){n.sendMsg(e,t.beforeMsg,function(){n.sendHousecardMsg(e,i,function(){n.sendMsg(e,t.afterMsg,function(e){a(e)})})})},function(){throw n.showErrorlog("无法获取房源卡片信息"),n.sendMsg(e,t.oriMsg,function(){a()},!0),new Error("无法获取房源卡片信息")})},getHouseCard:function(e,t,a){$.ajax({url:_util.apiUrl("house/house/gethousecard"),data:{house_code:e},dataType:"jsonp",success:function(e){if(0===e.errno){var n={houseCode:e.data.house_code,houseName:e.data.title,houseImgUrl:e.data.cover_pic,houseHallCount:e.data.blueprint_hall_num,houseBedroomCount:e.data.blueprint_bedroom_num,area:e.data.area,price:e.data.price,orientation:e.data.orientation,schemeUrl:e.data.m_url};switch(e.data.house_type){case"ershoufang":case"sell":n.houseType=1;break;case"zufang":case"rent":n.houseType=1}switch(e.data.house_state){case"zai_shou":n.houseState=1;break;case"yi_shou":n.houseState=2;break;case"ting_shou":n.houseState=3}t&&t(n)}else a&&a()}})},sendXinfangcardMsg:function(e,t,a){a=a||_util.noop,this.core.sendTo(e,{type:6,localId:+new Date,payload:JSON.stringify(t)},function(e){a(e)})},sendXinfangcard:function(e,t,a,n){a=a||_util.noop;var i=this;i.getXinfangCard(t.project_name,function(n){i.sendMsg(e,t.beforeMsg,function(){i.sendXinfangcardMsg(e,n,function(){i.sendMsg(e,t.afterMsg,function(e){a(e)})})})},function(n){throw i.showErrorlog("无法获取房源卡片信息"),i.sendMsg(e,t.oriMsg,function(){a()},!0),new Error("无法获取房源卡片信息")},n)},getXinfangCard:function(e,t,a,n){$.ajax({url:_util.xinfangUrl("xinfang/card"),data:{project_name:e.replace("p_","")},dataType:"jsonp",success:function(e){if(1===e.code){var i={buildingId:e.data.resblock_id,buildingName:e.data.name,buildingImgUrl:e.data.image_url,avgPrice:e.data.avg_price,area:e.data.area,roomType:e.data.room_type,houseType:e.data.house_type,address:e.data.location,cityCode:e.data.city_code,projectName:e.data.project_name,schemeUrl:e.data.m_url,fromType:n?1:0};t&&t(i)}else a&&a()},error:function(e){a&&a(e)}})},sendZulincardMsg:function(e,t,a){a=a||_util.noop,this.core.sendTo(e,{type:1,localId:+new Date,payload:JSON.stringify(t)},function(e){a(e)})},sendZulincard:function(e,t,a,n){a=a||_util.noop;var i=this;i.getZulincard(t.house_code,function(n){i.sendMsg(e,t.beforeMsg,function(){i.sendZulincardMsg(e,n,function(){i.sendMsg(e,t.afterMsg,function(e){a(e)})})})},function(n){throw i.showErrorlog("无法获取房源卡片信息"),i.sendMsg(e,t.oriMsg,function(){a()},!0),new Error("无法获取房源卡片信息")},n)},getZulincard:function(e,t,a,n){function i(e,t){var a=[];return $.each(e,function(e,t){a.push(e+"="+t)}),a.sort(),a.join(t)}var o="74bd10b352473fd0ebac140dc9585581",s={house_code:e,ts:(Date.now()/1e3).toFixed(0)},r=i(s,"&"),c=i(s,"");$.ajax({url:_util.zulinUrl("v1/house/baseinfo")+"?"+r+"&rent_sign="+md5(o+c+"v1/house/baseinfo")+"&rent_app_id=lianjiaIM",data:{},dataType:"json",success:function(e){if(0===e.status){var n=e.data||{},i=n.layout?n.layout.match(/(\d+)室(\d+)厅(\d+)卫/)||[]:[],o={houseCode:n.house_code,houseType:2,houseName:n.house_title,houseImgUrl:n.list_picture,houseHallCount:parseInt(i[1],10)||0,houseBedroomCount:parseInt(i[2],10)||0,area:parseFloat(n.rent_area,10)||0,price:parseFloat(n.rent_price_listing,10)||0,orientation:n.frame_orientation,schemeUrl:n.h5_landing_page};t&&t(o)}else a&&a()},error:function(e){a&&a(e)}})},sendKeErshouCard:function(e,t,a,n){a=a||_util.noop;var i=this;i.getKeErshouCard(t.house_code,function(n){i.sendMsg(e,t.beforeMsg,function(){i.sendHousecardMsg(e,n,function(){i.sendMsg(e,t.afterMsg,function(e){a(e)})})})},function(n){throw i.showErrorlog("无法获取房源卡片信息"),i.sendMsg(e,t.oriMsg,function(){a(n)},!0),new Error("无法获取房源卡片信息")},n)},getKeErshouCard:function(e,t,a,n){$.ajax({url:_util.ke_ershouUrl("info/cardinfo"),data:{type:"pc",source:"im",houseCode:e,token:md5(e+"im_fds1324ere][;4%7!390")},type:"GET",dataType:"jsonp",success:function(e){if(0===e.error_code){var n=e.data||{},i={houseCode:n.houseCode,houseType:n.houseType||1,isPriceOnly:n.isPriceOnly,houseName:n.houseName,houseImgUrl:n.houseImgUrl,houseHallCount:n.houseHallCount,houseBedroomCount:n.houseBedroomCount,area:n.area,price:n.price,orientation:n.orientation,schemeUrl:n.schemeUrl};t&&t(i)}else a&&a()},error:function(e){a&&a(e)}})},fold:function(e){e!==this.isFolding&&(this.isFolding=e,e?(this.rootnode.addClass("im-fold"),this.showWindow(!1),this.showBang(!1)):(this.rootnode.removeClass("im-fold"),this.visibleBang?this.showBang(!0):""!==this.currentConvId&&this.showWindow(!0)))},showWindow:function(e){this.scrollWindow("btm"),this.nodes.talkwindow[e?"show":"hide"](),e&&(this.visibleBang=!1,this.showBang(!1))},showBang:function(e,t){e&&(this.visibleBang=!0),this.nodes.talkBang[e?"show":"hide"](),e&&this.showWindow(!1),t&&(this.rootnode.removeClass("im-fold"),this.isFolding=!1),this.scrollBangWindow("bottom")},scrollWindow:function(e){switch(e){case"top":this.nodes.talkwindowChatContainer.scrollTop(0);break;case"btm":this.nodes.talkwindowChatContainer.scrollTop(this.nodes.talkwindowMsgContainer.height());break;default:this.nodes.talkwindowChatContainer.scrollTop(e)}},renderConvList:function(e){var t=this;e||(e=t.imData),t.nodes.listItemContainer.html("");var a=[],n=0;$.each(e,function(e,t){1===t.convObj.type&&a.push(t)}),a.sort(function(e,t){return e.convObj.mTime-t.convObj.mTime}),$.each(a,function(e,a){var i=a.convObj;t.addConvItemNode(i),n++}),n>0?(t.nodes.noagentContainer.hide(),t.nodes.listItemContainer.show()):(t.nodes.listItemContainer.hide(),t.nodes.noagentContainer.show())},updateImDataConv:function(e,t,a){this.imData[e]||(this.imData[e]={convObj:null,msgList:[],itemNode:null,readMsgId:0,hasHistory:!0});var n=this.imData[e];switch(t){case"convObj":n.convObj=a;break;case"msgList":n.msgList=a;break;case"itemNode":n.itemNode=a;break;case"readMsgId":n.readMsgId=a;break;case"hasHistory":n.hasHistory=a}},addConvItemNode:function(e){if(e&&e.peer&&(!e.peer||"SN_LJBB"!==e.peer.ucid)&&1==e.type){var t=$(this.listItemTemplate.render({item:{user_status:1,convId:e.id,convType:e.type,id:e.peer.ucid,name:e.title,avatar:e.avatar,summary:e.summary}}));this.updateImDataConv(e.id,"itemNode",t),this.nodes.listItemContainer.prepend(t),this.updateConvItemNode(e.id,{text:e.lastMsg,time:e.mTime})}},updateConvItemNode:function(e,t,a){var n=this.imData[e].itemNode;if(n){var i=n.find('[data-role="im-listitem-item-newmsg"]'),o=+i.attr("data-newmsg");t.text&&n.find('[data-role="im-listitem-item-text"]').html(t.text),t.time&&n.find('[data-role="im-listitem-item-time"]').html(_util.timeFormat(t.time,"deltaTime","YYYY-MM-DD")),void 0!==t.newmsgAmount&&("string"==typeof t.newmsgAmount&&null!==t.newmsgAmount.match(/\+/g)?o+=+t.newmsgAmount.replace(/\+/g,""):"number"==typeof t.newmsgAmount&&(o=t.newmsgAmount),i.attr({"data-newmsg":o}).html(o<=99?o:"99+"),o>0?i.show():i.hide()),a&&this.nodes.listItemContainer.prepend(n)}},updateHeadUnread:function(){var e=0;$.each(this.nodes.listItemContainer.find('[data-role="im-listitem-item"]'),function(){e+=+$(this).find('[data-role="im-listitem-item-newmsg"]').attr("data-newmsg")}),e+=+this.nodes.serviceItemContainer.find('[data-role="im-listitem-item-newmsg"]').attr("data-newmsg"),this.nodes.headUnread.attr({"data-newmsg":e}).html(e<=99?e:"99+"),e>0?this.nodes.headUnread.show():this.nodes.headUnread.hide()},updatePcard:function(e){var t=function(e,t,a){var n="";return n=null===e?t:a?a.replace(/<r>/g,e):e};this.nodes.pcard.find('[data-role="im-pcard-avatar"]').attr({src:e.photo_url.replace(/\d+x\d+/g,"78x78")}),this.nodes.pcard.find('[data-role="im-pcard-name"]').html(e.name),this.nodes.pcard.find('[data-role="im-pcard-grade"]').html(t(e.agent_level,"")),this.nodes.pcard.find('[data-role="im-pcard-district"]').html(t(e.bizcircle_name,"暂无")),this.nodes.pcard.find('[data-role="im-pcard-store"]').html(t(e.shop_name,"暂无")),this.nodes.pcard.find('[data-role="im-pcard-workage"]').html(t(e.job_year,"暂无")),this.nodes.pcard.find('[data-role="im-pcard-totaldeal"]').html(t(e.house_sold_count,"暂无")),this.nodes.pcard.find('[data-role="im-pcard-monthshow"]').html(t(e.recent_see,"暂无")),this.nodes.pcard.find('[data-role="im-pcard-praiserate"]').html(t(e.review_good_rate,"暂无","<r>%")),this.nodes.pcard.find('[data-role="im-pcard-shoplink"]').attr({href:"https://dianpu.lianjia.com/"+e.agent_ucid})},setWindow:function(e){var t=this,a=this.imData[e],n=a.convObj,i=n.peer.type,o=n.peer.ucid,s=this.filterSupportMsg(a.msgList);this.currentConvId=+e,this.nodes.talkwindowMsgContainer.html(""),this.nodes.inputTextarea.val(""),this.nodes.talkwindow.find('[data-role="im-window-name"]').html(n.title),s.length>0?this.addMsg(s,"btm"):this.loadHist(!0),1===i&&(this.agentData[o]||$.ajax({url:_util.apiUrl("im/agent/getagentdetail"),data:{agent_ucid:o},dataType:"jsonp",success:function(e){console.log(e),t.agentData[o]=e.data}})),t.updateConvItemNode(e,{newmsgAmount:0}),t.updateHeadUnread()},loadHist:function(e){var t=this;if(!t.isLoadingHistory&&0===t.nodes.talkwindowChatContainer.scrollTop()){var a=t.currentConvId,n=t.imData[t.currentConvId].msgList[0],i=0;if(n){if(1===n.id||t.imData[t.currentConvId].hasHistory===!1)return;i=n.sendTime}t.isLoadingHistory=!0,t.core.getHistory({conv_id:a,max_send_time:i,limit:100},function(n){if(null!==n){var i=t.filterSupportMsg(n);t.updateImDataConv(a,"msgList",n.reverse().concat(t.imData[a].msgList));var o=t.nodes.talkwindowMsgContainer.find("li.chat-block").eq(0);t.addMsg(i,"top");var s=t.nodes.talkwindowMsgContainer.find("li.chat-block").eq(0);e?t.scrollWindow("btm"):o[0]&&s[0]&&t.scrollWindow(o[0].getBoundingClientRect().top-s[0].getBoundingClientRect().top),0!==n.length&&1!==n[0].id||t.updateImDataConv(a,"hasHistory",!1)}else t.showErrorlog("获取历史记录失败");t.isLoadingHistory=!1})}},addMsg:function(e,t){var a=this,n=6e4;e.length>0&&($.each(e,function(){var e=this,i=null,o=null;if(!(a.nodes.talkwindowMsgContainer.find('[data-msgid="'+e.id+'"]').length>0)){var s="",r="",c="";switch(a.userData.ucid===e.fromUcid?(s="chat-out",r=a.userData.name,c=a.userData.avatar||a.staticRoot+"/pc/asset/lianjiaIM/img/icon_user@2x.png"):(s="chat-in",r=a.imData[e.convId].convObj.title,c=a.imData[e.convId].convObj.avatar||a.staticRoot+"/pc/asset/img/jingjiren/noimg.jpg"),e.type){case-1:case 105:i=$(a.messageNodeTemplate.render({sendType:s,timestamp:e.sendTime,msgid:e.id,user:{username:r,avatar:c},message:{text:a.core.encodeHtml(e.payload)}}));break;case-2:i=$(a.picNodeTemplate.render({sendType:s,timestamp:e.sendTime,msgid:e.id,user:{username:r,avatar:c},pic:{url:JSON.parse(e.payload).original,thumb:JSON.parse(e.payload).thumbnail,desc:"图片"}}));break;case 109:i=$(a.picNodeTemplate.render({sendType:s,timestamp:e.sendTime,msgid:e.id,user:{username:r,avatar:c},pic:{url:JSON.parse(e.payload).emoticonRemoteUrl,thumb:JSON.parse(e.payload).emoticonRemoteUrl,desc:JSON.parse(e.payload).emoticonName}}));break;case 1:var d=JSON.parse(e.payload);d.houseImgUrl&&null!==d.houseImgUrl.match(/http/g)||(d.houseImgUrl=a.staticRoot+"/pc/asset/img/new-version/default_block.png"),1===d.isPriceOnly?d.priceUnit="万起":d.priceUnit="万",3!=d.houseType&&2!=d.houseType||(d.price=1e4*d.price,d.priceUnit="元/月"),i=$(a.housecardNodeTemplate.render({sendType:s,timestamp:e.sendTime,msgid:e.id,user:{username:r,avatar:c},houseinfo:d}));break;case 6:var l=JSON.parse(e.payload);l.houseImgUrl&&null!==l.houseImgUrl.match(/http/g)||(l.houseImgUrl=a.staticRoot+"/pc/asset/img/new-version/default_block.png"),i=$(a.xinfangcardNodeTemplate.render({sendType:s,timestamp:e.sendTime,msgid:e.id,user:{username:r,avatar:c},houseinfo:l}));break;default:i=$(a.messageNodeTemplate.render({sendType:s,timestamp:e.sendTime,msgid:e.id,user:{username:r,avatar:c},message:{text:a.core.encodeHtml(e.type+"-暂不支持消息类型，请前往app查看")}}))}i&&(i.data({msgData:e}),"btm"===t?(o=a.nodes.talkwindowMsgContainer.find("li.chat-block:last"),(0===o.length||e.sendTime-o.data("msgData").sendTime>n)&&a.nodes.talkwindowMsgContainer.append(a.chatTimeNodeTemplate.render({time:_util.timeFormat(e.sendTime,"deltaTime","YYYY-MM-DD hh:mm")})),a.nodes.talkwindowMsgContainer.append(i)):"top"===t&&(o=a.nodes.talkwindowMsgContainer.find("li.chat-block:first"),a.nodes.talkwindowMsgContainer.prepend(i),(0===o.length||e.sendTime-o.data("msgData").sendTime<-n)&&a.nodes.talkwindowMsgContainer.prepend(a.chatTimeNodeTemplate.render({time:_util.timeFormat(e.sendTime,"deltaTime","YYYY-MM-DD hh:mm")}))))}}),this.addRead(e.slice(-1)[0]))},addRead:function(e){e.fromUcid!==this.userData.ucid&&e.id>0&&e.id>this.imData[e.convId].readMsgId&&(this.updateImDataConv(e.convId,"readMsgId",e.id),this.core.markRead(e))},showErrorlog:function(e){var t=this;clearTimeout(this.errorlogTimer),this.nodes.errorlogContainer.hide().html(e).fadeIn(200,function(){t.errorlogTimer=setTimeout(function(){t.nodes.errorlogContainer.fadeOut(200,function(){t.nodes.errorlogContainer.html("")})},2e3)})}},function(){var e=document.createElement("style");e.innerText=".im-housecard img{vertical-align: baseline;}",document.body.appendChild(e)}(),LianjiaIM});